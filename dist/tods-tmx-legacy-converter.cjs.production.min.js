"use strict";var t=require("tods-competition-factory"),e=require("d3"),n=require("normalize-text"),r=require("date-fns");function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}var i={S:"normal",F:"final"},o=function(){var t={};function e(t){if(t&&"object"==typeof t){if(t.tiebreakSet)return n(t.tiebreakSet);var e=u(t.setTo);if(e){var r=t.NoAD?"NOAD":"",a=n(t.tiebreakFormat),i=a&&!a.invalid&&"/"+a||"",o=u(t.tiebreakAt);return a&&a.invalid?{invalid:!0}:""+e+r+i+(o&&o!==e&&"@"+o||"")}return{invalid:!0}}}function n(t){if(t)return"object"==typeof t&&u(t.tiebreakTo)?"TB"+t.tiebreakTo+(t.NoAD?"NOAD":""):{invalid:!0}}function r(t){if(t&&":"===t[1]){var e=t.split(":"),n=e[1];if(i[e[0]]&&n){if(0===n.indexOf("TB"))return{tiebreakSet:a(n)};var r=t.match(/^[FS]{1}:(\d+)([A-Za-z]*)/),s=r&&o(r[2])||!1,c=!r||!r[2]||s,d=r&&u(r[1]),f=function(t){var e=t&&t.indexOf("@")>0&&t.split("@");if(e)return u(e[1])||{invalid:!0}}(n),l=!f||f&&!f.invalid,m=l&&f||d,p=a(n.split("/")[1]),h=!p||!p.invalid,v={setTo:d};return s&&(v.NoAD=!0),p?(v.tiebreakFormat=p,v.tiebreakAt=m):v.noTiebreak=!0,d&&c&&h&&l&&v||{invalid:!0}}}}function a(t){if(t){if(0===t.indexOf("TB")){var e=t.match(/^TB(\d+)([A-Za-z]*)/),n=e&&e[1],r=e&&o(e[2]),a=!e||!e[2]||r,i=u(n);if(i&&a){var s={tiebreakTo:i};return r&&(s.NoAD=!0),s}return{invalid:!0}}return{invalid:!0}}}function o(t){return t&&t.indexOf("NOAD")>=0}function u(t){return!isNaN(Number(t))&&Number(t)}return t.stringify=function(t){if(t&&"object"==typeof t){if(t.timed&&!isNaN(t.minutes))return function(t){return"T"+t.minutes}(t);if(t.bestOf&&t.setFormat)return function(t){var n=u(t.bestOf),r=n&&"SET"+n||"",a=e(t.setFormat),i=a&&"S:"+a||"",o=e(t.finalSetFormat);if(r&&a&&!a.invalid&&(!o||!o.invalid))return[r,i,n>1&&o&&!o.invalid&&"F:"+o||""].filter((function(t){return t})).join("-")}(t)}},t.parse=function(t){if(t&&"string"==typeof t){var e=0===t.indexOf("T")?"timed":0===t.indexOf("SET")?"SET":"";if("timed"===e)return function(t){var e=u(t.slice(1));if(e)return{timed:!0,minutes:e}}(t);if("SET"===e)return function(t){var e=t.split("-"),n=u(e[0].slice(3)),a=e&&r(e[1]),i=e&&r(e[2]),o=n&&n<6,s=!e[2]||i&&!i.invalid,c=a&&!a.invalid,d={bestOf:n,setFormat:a};if(i&&(d.finalSetFormat=i),o&&c&&s)return d}(t)}},t}(),u=function(){var t={};function e(t){return!isNaN(Number(t))&&Number(t)}return t.jsonTODS=function(t){var n={bestOf:e(t.max_sets)};if(t.max_sets&&1===parseInt(t.max_sets)&&t.final_set_supertiebreak)n.setFormat={tiebreakSet:{tiebreakTo:t.supertiebreak_to}};else{var r=e(t.games_for_set),a=e(t.tiereaks_at);n.setFormat={setTo:r,tiebreakAt:a>r?r:a,tiebreakFormat:{tiebreakTo:e(t.tiebreak_to)}},t.final_set_supertiebreak&&(n.finalSetFormat={tiebreakSet:{tiebreakTo:t.supertiebreak_to}})}return n},t}(),s=function(){var t={};function e(t){var e={},n={},r=(t=t||"00:00")&&t.split(" ")||"";e.time=r[0],e.ampm=r[1];var a=e.time&&e.time.split(":")||"";return n.hours=a[0],n.minutes=a[1],n.ampm=e.ampm,n}function n(e,n,r){if(void 0===n&&(n="-"),void 0===r&&(r="YMD"),!e)return"";isNaN(e)||(e=t.offsetTime(e));var a=new Date(e),i=""+(a.getMonth()+1),o=""+a.getDate(),u=a.getFullYear();return i.length<2&&(i="0"+i),o.length<2&&(o="0"+o),"DMY"===r?[o,i,u].join(n):"MDY"===r?[i,o,u].join(n):"YDM"===r?[u,o,i].join(n):"DYM"===r?[o,u,i].join(n):"MYD"===r?[i,u,o].join(n):[u,i,o].join(n)}return t.localizeDate=function(t,e,n){return t.toLocaleDateString(n,e||{weekday:"long",year:"numeric",month:"long",day:"numeric"})},t.timeSort=function(t,n){var r=e(t),a=e(n);if(parseInt(r.hours)<parseInt(a.hours))return-1;if(parseInt(r.hours)>parseInt(a.hours))return 1;if(r.hours===a.hours){if(parseInt(r.minutes)<parseInt(a.minutes))return-1;if(parseInt(r.minutes)>parseInt(a.minutes))return 1}return 0},t.militaryTime=function(t,n){var r=e(t||n.schedule.default_time);return r.ampm&&r.hours&&("pm"===r.ampm.toLowerCase()&&parseInt(r.hours)<12&&(r.hours=(r.hours&&parseInt(r.hours)||0)+12),"am"===r.ampm.toLowerCase()&&"12"===r.hours&&(r.hours="00")),(r.hours||"12")+":"+(r.minutes||"00")},t.regularTime=function(t,n){var r=e(t||n.schedule.default_time);return r.ampm?t:(r.hours>12?(r.hours-=12,r.ampm="PM"):"12"===r.hours?r.ampm="PM":"00"===r.hours?(r.hours="12",r.ampm="AM"):r.ampm="AM",(r.hours||"12")+":"+(r.minutes||"00")+" "+r.ampm)},t.convertTime=function(e,n){return!n||n.schedule.time24?t.militaryTime(e,n):t.regularTime(e,n)},t.addWeek=function(t){var e=new Date(t);return e.setDate(e.getDate()+7)},t.subtractWeek=function(t){var e=new Date(t);return e.setDate(e.getDate()-7)},t.getDateByWeek=function(t,e){var n=new Date(e,0,1),r=n.getDay(),a=7*--t;return(0!==r||r>4)&&(a+=7),n.setDate(1-n.getDay()+ ++a),n},t.HHMMSS=function(t,e){var n=parseInt(t,10),r=Math.floor(n/3600),a=Math.floor((n-3600*r)/60),i=n-3600*r-60*a;return r<10&&(!e||e&&e.pad_hours)&&(r="0"+r),a<10&&(a="0"+a),i<10&&(i="0"+i),!e||e&&e.display_seconds?r+":"+a+":"+i:r+":"+a},t.weekDays=function(t){return[0,1,2,3,4,5,6].map((function(e){return function(t,e){var n=new Date(t),r=e-n.getDay();return new Date(n.setDate(n.getDate()+r))}(t,e)}))},t.ymd2date=function(t){var e=t.split("-");return e&&3===e.length?isNaN(parseInt(e[1]))?new Date(t):new Date(e[0],parseInt(e[1])-1,e[2]):new Date(t)},t.formatDate=n,t.offsetDate=function(t){var e=t?new Date(t):new Date,n=e.getTimezoneOffset();return new Date(e.getTime()+60*n*1e3)},t.offsetTime=function(e){return t.offsetDate(e).getTime()},t.validDate=function(e,r){if(!e)return!1;var a=n(e).split("-");return!(isNaN(a.join(""))||3!==a.length||4!==a[0].length||+a[1]>12||+a[1]<1||+a[2]>31||+a[2]<1||r&&r.start&&t.offsetDate(e)<t.offsetDate(r.start)||r&&r.end&&t.offsetDate(e)>t.offsetDate(r.end)||"Invalid Date"===new Date(e))},t.isDate=function(t){if("boolean"==typeof t)return!1;var e=t instanceof Date?t:!isNaN(t)&&new Date(t);return e&&!isNaN(e.valueOf())},t.timeUTC=function(t){var e=new Date(t);return Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())},t.dateFromDay=function(t,e){var n=new Date(t,0);return new Date(n.setDate(e))},t.randomDate=function(t,e){return new Date(t.getTime()+Math.random()*(e.getTime()-t.getTime()))},t.dateRange=function(e,n){var r,a=[],i=0,o=!0;if(t.isDate(n)&&t.isDate(e)&&(r=n,t.offsetDate(e)<=t.offsetDate(r)))for(var u=t.offsetDate(e),s=t.offsetDate(n);u<=s&&o;)(i+=1)>300&&(console.log("excessive while loop"),o=!1),a.push(new Date(u)),u.setDate(u.getDate()+1);else console.log("error occured!!!... Please Enter Valid Dates");return a},t.sameDay=function(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()},t.futureDate=function(t){void 0===t&&(t=1);var e=new Date;return e.setDate(e.getDate()+t),e},t}();function c(e){var n,r,a,i,c,l,m=e.eventType,p=e.seedLimit,h=e.tieFormat,v=e.entryStage,_=e.legacyMatch,g=e.participants,y=e.matchUpFormat,w=e.participantIds,b=e.drawPositionOffset,E=void 0===b?0:b,I=e.tournamentEngine,O=(null==(n=_.match)?void 0:n.muid)||_.muid,D=[],S=[],k=[],M=[],T=[],N=!1;Array.isArray(_.teams)&&_.teams.forEach((function(e,n){if(null!=e&&e.length){var r,a=e.map((function(t){return null==t?void 0:t.id})).filter((function(t){return t})),i=e&&e[0]&&"object"==typeof e[0]&&e[0],o=e&&e[1]&&"object"==typeof e[1]&&e[1],u=((null==i?void 0:i.draw_position)||(null==o?void 0:o.draw_position))+E,s=null==i?void 0:i.seed,c=null==i?void 0:i.bye;if(1===a.length&&(r=a[0]),2===a.length){var d,f=I.getPairedParticipant({participantIds:a}).participant;if(!f){var l=I.addParticipant({participant:{participantType:"PAIR",participantRole:"COMPETITOR",individualParticipantIds:[i.id,o.id]}});M.push(f=l.participant)}r=null==(d=f)?void 0:d.participantId}var m={sideNumber:n+1};u&&(m.drawPosition=u),c&&(m.bye=c,N=!0),r&&(m.participantId=r),D.push(m),r&&!w.includes(r)?(w.push(r),S.push({entryStage:v,participantId:r,entryStatus:t.entryStatusConstants.DIRECT_ACCEPTANCE}),T.push({drawPosition:u,participantId:r}),s&&s<=p&&k.push({seedNumber:s,seedValue:s,participantId:r})):c&&T.push({drawPosition:u,bye:c})}}));var x="TEAM"===m?null==(r=_.format)?void 0:r.toUpperCase():m,A=null==h?void 0:h.collectionDefinitions.find((function(t){return t.matchUpType===x})),C=null==A?void 0:A.collectionId,F=(null==(a=_.match)?void 0:a.score)||_.score||"",U=function(t,e){void 0===e&&(e=" ");var n=null;if(t){var r=t.split(e).map((function(t){var e=t.indexOf("/")>0?"/":"-",n=t.split(e).map(a).reverse().filter((function(t){return t})),r=n.map((function(t){return t.games})),i=n.map((function(t){return t.tiebreak})).filter((function(t){return t})),o=1===i.length?"("+i[0]+")":"";return""+(i.length<2?r.join(e):r.map((function(t,e){return t+"("+i[e]+")"})).join(e))+o})).join(e);return n?n+" "+r:r}function a(t){var e=/(\d+)/,r=/(\d+)\((\d+)\)/;return r.test(t)?{games:r.exec(t)[1],tiebreak:r.exec(t)[2]}:e.test(t)?{games:e.exec(t)[1]}:void(n=t)}}(F)||"",R=void 0!==(null==(i=_.match)?void 0:i.winner_index)&&_.match.winner_index;[0,1].includes(parseInt(R))||(R=_.winner_index);var j=[0,1].includes(parseInt(R)),P=j&&R+1||void 0,L=f(j&&1!==P?U:F),q={scoreStringSide1:L,scoreStringSide2:f(j&&1!==P?F:U),sets:t.mocksEngine.parseScoreString({scoreString:L})},B=F.indexOf("TIME")>0,V=F.indexOf("LIVE")>0,G=F.indexOf("INT")>0,Q=F.indexOf("INC")>0,z=F.indexOf("W.O.")>=0,W=F.indexOf("CCL")>=0,H=F.indexOf("ABD")>=0,Y=F.indexOf("DEF")>=0,K=F.indexOf("RET")>0,X=V&&t.matchUpStatusConstants.IN_PROGRESS||G&&t.matchUpStatusConstants.SUSPENDED||Q&&t.matchUpStatusConstants.INCOMPLETE||z&&t.matchUpStatusConstants.WALKOVER||W&&t.matchUpStatusConstants.NOT_PLAYED||H&&t.matchUpStatusConstants.ABANDONED||Y&&t.matchUpStatusConstants.DEFAULTED||K&&t.matchUpStatusConstants.RETIRED||N&&t.matchUpStatusConstants.BYE||P&&t.matchUpStatusConstants.COMPLETED||B&&t.matchUpStatusConstants.COMPLETED||!P&&t.matchUpStatusConstants.TO_BE_PLAYED,Z=function(e){var n,r,a=e.participants,i=e.legacyMatch,o=[],u=(null==(n=i.match)?void 0:n.schedule)||i.schedule||{},c=(null==(r=i.match)?void 0:r.umpire)||i.umpire;if(u.luid&&u.index){var f={itemType:"SCHEDULE.ASSIGNMENT.VENUE",itemValue:u.luid,timeStamp:(new Date).toISOString()};o.push(f),f={itemType:"SCHEDULE.ASSIGNMENT.COURT",itemValue:u.luid+"|"+(parseInt(u.index)-1),timeStamp:(new Date).toISOString()},o.push(f)}if(u.day){var l={itemType:"SCHEDULED.DATE",itemValue:u.day,timeStamp:(new Date).toISOString()};if(o.push(l),u.start){var m=d(u.start),p=s.formatDate(u.day)+"T"+m,h={itemType:"SCHEDULE.TIME.START",itemValue:new Date(p).toISOString(),timeStamp:(new Date).toISOString()};o.push(h)}if(u.end){var v=d(u.end),_=s.formatDate(u.day)+"T"+v,g={itemType:"SCHEDULE.TIME.END",itemValue:new Date(_).toISOString(),timeStamp:(new Date).toISOString()};o.push(g)}}if(u.time){var y={itemType:"SCHEDULE.TIME.SCHEDULED",itemValue:d(u.time),timeStamp:(new Date).toISOString()};o.push(y)}if(c){var w=(null==a?void 0:a.filter((function(e){return e.participantType===t.participantConstants.INDIVIDUAL&&e.participantRole===t.participantRoles.OFFICIAL}))).find((function(t){return t.name===c})),b=null==w?void 0:w.participantId,E={itemType:"SCHEDULE.ASSIGNMENT.OFFICIAL",itemValue:b,timeStamp:(new Date).toISOString()};b&&o.push(E)}return o}({participants:g,legacyMatch:_}),J={matchUpId:O,score:q},$=null==D?void 0:D.map((function(t){return t.drawPosition})).filter((function(t){return t}));null!=$&&$.length&&(J.drawPositions=$),null!=D&&D.length&&(J.sides=D),x&&(J.matchUpType=x),P&&(J.winningSide=P),null!=Z&&Z.length&&(J.timeItems=Z),C&&(J.collectionId=C),X&&(J.matchUpStatus=X);var tt=(null==(c=_.match)?void 0:c.score_format)||_.score_format,et=tt&&o.stringify(u.jsonTODS(tt));y=(null==(l=_.match)?void 0:l.matchFormat)||y,(et||y)&&(J.matchUpFormat=et||y);var nt=_.sequence;return nt&&(J.collectionPosition=nt),{matchUp:J,entries:S,seedAssignments:k,positionAssignments:T,missingParticipants:M}}function d(t){return s.militaryTime(t).split(":").map((function(t){return(e=t).toString()[1]?e:"0"+e;var e})).join(":")}function f(t){return void 0===t&&(t=""),t.split(" ").map((function(t){return t.includes("/")?function(t){return"["+t.split("/").join("-")+"]"}(t):t})).join(" ")}var l={C:"CLAY",H:"HARD",G:"GRASS",R:"CARPET"};function m(t){return l[null==t?void 0:t.surface]}function p(t){return"o"===(null==t?void 0:t.inout)?"OUTDOOR":"i"===(null==t?void 0:t.inout)&&"INDOOR"}function h(t,e){return t.filter((function(t){return-1!==e.indexOf(t)})).filter((function(t,e,n){return n.indexOf(t)===e}))}function v(e){return e?["F","FEMALE","W","WOMAN"].includes(e.toUpperCase())?t.genderConstants.FEMALE:["M","MALE","MAN"].includes(e.toUpperCase())?t.genderConstants.MALE:t.genderConstants.MIXED:t.genderConstants.MIXED}function _(e){var n=e.legacyEvent,r={E:t.drawDefinitionConstants.MAIN,Q:t.drawDefinitionConstants.QUALIFYING,S:t.drawDefinitionConstants.MAIN,C:t.drawDefinitionConstants.CONSOLATION,P:t.drawDefinitionConstants.PLAY_OFF,A:t.drawDefinitionConstants.MAIN};return"R"===n.draw_type?Object.keys(n.links||{}).includes("E")?t.drawDefinitionConstants.QUALIFYING:t.drawDefinitionConstants.MAIN:r[n.draw_type]}var g=function(){var t={isActiveEvent:function(t){var e=t.e;return e&&e.active},isAdHoc:function(t){var e=t.e;return e&&e.draw_type&&"A"===e.draw_type},isPlayoff:function(t){var e=t.e;return e&&e.draw_type&&"P"===e.draw_type},isQualifying:function(t){var e=t.e;return e&&e.draw_type&&"Q"===e.draw_type},isRoundRobin:function(t){var e=t.e;return e&&e.draw_type&&"R"===e.draw_type},isConsolation:function(t){var e=t.e;return e&&e.draw_type&&"C"===e.draw_type},isElimination:function(t){var e=t.e;return e&&e.draw_type&&"E"===e.draw_type},hasEliminationStructure:function(t){var e=t.e;return e&&e.draw_type&&["E","Q","C","P","S"].indexOf(e.draw_type)>=0},isCompass:function(t){var e=t.e;return e&&(e.draw_type&&["S","O"].indexOf(e.draw_type)>=0||e.direction||e.draw&&e.draw.compass)},isFeedIn:function(t){var e=t.e,n=t.value;return n&&"feed"===n||e&&e.structure&&"feed"===e.structure},isBackdraw:function(t){var e=t.e,n=t.value;return n&&"backdraw"===n||e&&e.structure&&"backdraw"===e.structure},hasRoundNames:function(t){var e=t.e;return e&&e.draw_type&&["E","S","C","O"].indexOf(e.draw_type)>=0},isConsolationFeedIn:function(e){var n=e.e;return t.isConsolation({e:n})&&t.isFeedIn({e:n})},isConsolationBackdraw:function(e){var n=e.e;return t.isConsolation({e:n})&&t.isBackdraw({e:n})},isConsolationFixed:function(e){var n=e.e;return t.isConsolation({e:n})&&(t.isFeedIn({e:n})||t.isBackdraw({e:n}))},isSingles:function(t){var e=t.e,n=t.match;return e?e.format&&("S"===e.format||"singles"===e.format.toLowerCase()):n?n.format&&("S"===n.format||"singles"===n.format.toLowerCase()):void 0},isDoubles:function(t){var e=t.e,n=t.match;return e?e.format&&("D"===e.format||"doubles"===e.format.toLowerCase()):n?n.format&&("D"===n.format||"doubles"===n.format.toLowerCase()):void 0},isTeam:function(t){var e=t.tournament,n=t.e;return e&&e.type?["team","dual"].indexOf(e.type)>=0:n&&(n&&n.draw&&n.draw.dual_matches||"dual"===n.event_type)},isPreRound:function(e){var n=e.env,r=e.e,a=n&&n.drawFx&&n.drawFx.qualifying_bracket_seeding;return t.isQualifying({e:r})&&r.approved&&r.approved.length&&+r.qualifiers==r.draw_size/2&&a}};return t}();function y(t){return t?t.luid+"|"+t.index:""}function w(t,e){return Array.from({length:e-t},(function(e,n){return n+t}))}var b=function(){var t={};function e(t,e){var n=parseInt(t);return isNaN(n)?e:n}function n(t){var e=t.string_score,n=t.winner_index,a=t.split,i=void 0===a?" ":a,u=t.matchFormat;if(!e)return[];e=n?r(e):e;var s=null,c=/(\d+)/,d=/(\d+)\((\d+)\)/,f=o.parse(u),l=e.split(i).filter((function(t){return t})).map((function(t){if(t.indexOf("/")>0){var e=t.split("/").map((function(t){return c.exec(t)?{games:+c.exec(t)[1]}:void 0})).filter((function(t){return t}));if(2===e.length)return e}var n=null,r=t.split("-").map((function(t){var e;return d.test(t)?(n=+d.exec(t)[2],e={games:+d.exec(t)[1]}):c.test(t)?e={games:+c.exec(t)[1]}:s=t,e||void 0}));if(r=r.filter((function(t){return t})),null!==n){var a=Math.min.apply(Math,r.map((function(t){return t.games})));r.forEach((function(t){+t.games==+a?t.tiebreak=n:t.spacer=n}))}return r}));if((l=l.filter((function(t){return t&&2===t.length}))).forEach((function(t,e){var n=f&&(f.finalSetFormat||f.setFormat),r=n&&n.tiebreakSet&&n.tiebreakSet.tiebreakTo;(t[0].games>=r||t[1].games>=r)&&(t[0].supertiebreak=t[0].games,t[1].supertiebreak=t[1].games,delete t[0].games,delete t[1].games)})),void 0!==n&&(l.winner_index=n),s){if("Cancelled"===s&&(l.cancelled=!0),"Abandoned"===s&&(l.abandoned=!0),"INC."===s&&(l.incomplete=!0),"INT."===s&&(l.interrupted=!0),"LIVE"===s&&(l.live=!0),"TIME"===s&&(l.time=!0),"DEF."===s&&(l.default=!0),"W.O."===s&&(l.walkover=!0),!l.length)return l;void 0!==n&&(l[l.length-1][1-n].outcome=s,l[l.length-1].outcome=s,l.outome=s)}return l}function r(t,e){void 0===e&&(e=" ");var n=null;if(t){var r=t.split(e).map((function(t){var e=t.indexOf("/")>0?"/":"-",n=t.split(e).map(a).reverse().filter((function(t){return t})),r=n.map((function(t){return t.games})),i=n.map((function(t){return t.tiebreak})).filter((function(t){return t})),o=1===i.length?"("+i[0]+")":"";return""+(i.length<2?r.join(e):r.map((function(t,e){return t+"("+i[e]+")"})).join(e))+o})).join(e);return n?n+" "+r:r}function a(t){var e=/(\d+)/,r=/(\d+)\((\d+)\)/;return r.test(t)?{games:r.exec(t)[1],tiebreak:r.exec(t)[2]}:e.test(t)?{games:e.exec(t)[1]}:void(n=t)}}return t.setsToWin=function(t){return t&&Math.ceil(t/2)||1},t.tiebreakTo=function(t,e){return e?t&&t.finalSetFormat&&t.finalSetFormat.tiebreakFormat&&t.finalSetFormat.tiebreakFormat.tiebreakTo:t&&t.setFormat&&t.setFormat.tiebreakFormat&&t.setFormat.tiebreakFormat.tiebreakTo},t.matchFormat=function(t){return(t||"SET3-S:6/TB7").slice(3)},t.getExistingScores=function(t){var e=t.match;if(e&&e.score)return n({string_score:e.score,winner_index:e.winner_index,matchFormat:e.matchFormat})},t.generateMatchFormat=function(t){var n=t.cfg_obj,r=e(n.bestof.ddlb.getValue()),a={max_sets:r,sets_to_win:b.setsToWin(r),games_for_set:e(n.setsto.ddlb.getValue()),tiebreaks_at:e(n.tiebreaksat.ddlb.getValue())||"",tiebreak_to:e(n.tiebreaksto.ddlb.getValue()),supertiebreak_to:e(n.supertiebreakto.ddlb.getValue()),final_set_supertiebreak:"N"!==n.finalset.ddlb.getValue()};return{matchFormat:o.stringify(u.jsonTODS(a)),score_format:a}},t.getScoringFormat=function(t){var e,n,r,a,i,o=t.e,u=t.match;return n=(e={objects:[u&&u.score_format,u&&u.match&&u.match.score_format,o.scoring_format&&o.scoring_format[u&&u.format||("D"===o.format?"doubles":"singles")],o.score_format]}).source,a=void 0===(r=e.objects)?[]:r,i=Object.assign({},void 0===n?{}:n),a&&!Array.isArray(a)&&(a=[a]),(a=a.filter((function(t){return t}))).forEach((function(t){"object"==typeof t&&Object.keys(t).forEach((function(e){return i[e]=void 0!==i[e]?i[e]:t[e]}))})),i},t.defaultMatchFormat=function(t){var e=t.format,n=t.category,r=t.env.scoreboard.matchFormats,a={S:"singles",D:"doubles"};return Object.keys(a).indexOf(e)>=0&&(e=a[e]),e&&n&&r.categories[n]&&r.categories[n][e]?r.categories[n][e]:e&&r[e]?r[e]:r.singles},t.convertStringScore=n,t.reverseScore=r,t}(),E=function(){for(var t={},e=[],n=0;n<256;n++)e[n]=(n<16?"0":"")+n.toString(16);var r=function(){try{return window}catch(t){return}},a=r()&&r().crypto&&r().crypto.getRandomValues?function(){var t=new Uint32Array(4);return r().crypto.getRandomValues(t),{d0:t[0],d1:t[1],d2:t[2],d3:t[3]}}:function(){return{d0:4294967296*Math.random()>>>0,d1:4294967296*Math.random()>>>0,d2:4294967296*Math.random()>>>0,d3:4294967296*Math.random()>>>0}};return t.new=function(){return function(t){var n=t.d0,r=t.d1,a=t.d2,i=t.d3;return e[255&n]+e[n>>8&255]+e[n>>16&255]+e[n>>24&255]+"-"+e[255&r]+e[r>>8&255]+"-"+e[r>>16&15|64]+e[r>>24&255]+"-"+e[63&a|128]+e[a>>8&255]+"-"+e[a>>16&255]+e[a>>24&255]+e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]}(a())},t.idGen=function(){return"u_"+t.generate()},t.generate=function(){var t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&n]+e[n>>8&255]+"-"+e[n>>16&15|64]+e[n>>24&255]+"-"+e[63&r|128]+e[r>>8&255]+"-"+e[r>>16&255]+e[r>>24&255]+e[255&a]+e[a>>8&255]+e[a>>16&255]+e[a>>24&255]},t}();function I(t){return t.map((function(t){return t&&t.id})).filter((function(t){return t})).sort().join("-")}function O(t){var n={},r=function(t){return t.filter((function(t,e,n){return n.lastIndexOf(t)===+e}))},a=function(t,e){return e.reduce((function(e,n,r){return n===t&&e.push(r),e}),[])},i=function(t,e){return e.reduce((function(t,e){return t[e]=1+t[e]||1,t}),{})[t]||0},u=function(t,e){return t.filter((function(t){return-1!==e.indexOf(t)})).filter((function(t,e,n){return n.indexOf(t)===e}))},s=function(t){return t.length?t.splice(Math.floor(Math.random()*t.length),1)[0]:void 0},c=function(t,e,n,r){var a;return(a=[]).concat.apply(a,t.slice(0,e).concat(t.slice(e,e+n).sort(r),t.slice(e+n,t.length)))},d=[2,4,8,16,32,64,128,256,512],f=[2,4,8,12,16,24,32,48,64,96,128,256,512],l=function(t){return f.indexOf(t)>=0},m={rr_h2h_priority:!1,compressed_draw_formats:!0,compressed:{byes_adjacent_to_seeds:!1},seedBlocks:[[1],[2],[3,4],[5,8],[9,16],[17,32],[33,64]],seed_limits:[[0,0],[4,2],[11,4],[21,8],[41,16],[97,32],[193,64]],bye_placement:{8:[2,7,5],16:[2,15,11,6,7,10,14],32:[2,31,23,10,15,18,26,7,6,27,19,14,11,22,30],64:[2,63,47,18,31,34,50,15,10,55,39,26,23,42,58,7,5,60,44,21,28,37,53,12,13,52,36,29,20,45,61],128:[2,127,31,34,63,66,95,98,15,18,47,50,79,82,111,114,7,10,23,26,39,42,55,58,71,74,87,90,103,106,119,122],256:[2,255,63,66,127,130,191,194,31,34,95,98,159,162,223,226,15,18,47,50,79,82,111,114,143,146,175,178,207,210,239,242,7,10,23,26,39,42,55,58,71,74,87,90,103,106,119,122,135,138,151,154,167,170,183,186,199,202,215,218,231,234,247,250]},seedPositions:{1:[["1","0"]],2:[["0","1"]],3:[["1",".250"],["0",".750"]],5:[["0",".250"],["0",".500"],["1",".500"],["1",".750"]],9:[["1",".125"],["0",".375"],["1",".625"],["0",".875"],["0",".125"],["1",".375"],["0",".625"],["1",".875"]],13:[],17:[["1",".0625"],["0",".1875"],["1",".3125"],["0",".4375"],["1",".5625"],["0",".6875"],["1",".8125"],["0",".9375"],["0",".0625"],["1",".1875"],["0",".3125"],["1",".4375"],["0",".5625"],["1",".6875"],["0",".8125"],["1",".9375"]],25:[],33:[["1",".03125"],["0",".09375"],["1",".15625"],["0",".21875"],["1",".28125"],["0",".34375"],["1",".40625"],["0",".46875"],["1",".53125"],["0",".59375"],["1",".65625"],["0",".71875"],["1",".78125"],["0",".84375"],["1",".90625"],["0",".96875"],["0",".03125"],["1",".09375"],["0",".15625"],["1",".21875"],["0",".28125"],["1",".34375"],["0",".40625"],["1",".46875"],["0",".53125"],["1",".59375"],["0",".65625"],["1",".71875"],["0",".78125"],["1",".84375"],["0",".90625"],["1",".96875"]],49:[]},separation:{team:!0}};function p(t){var e=t.num_players,n=t.standardSizes,r=t.forceCompressed;if(!e||e<2)return 0;for(var a=0;f[a]<e;)a+=1;for(var i=0;d[i]<e;)i+=1;return n?d[i]:(r||m.compressed_draw_formats)&&e<=128?f[a]:d[i]}function h(t){for(var e=0;d[e]<t;)e+=1;return d[e]}function v(t,e){if(!t||!t.brackets)return[];var n,r=t.brackets[e],a=function(t){return t.map((function(t){return t.map((function(t){return t.id})).sort().join("-")})).sort().join("-")};return function(){var t;r.teams||(r.teams=r.players.map((function(t){return[t]})));var e=(t=[]).concat.apply(t,r.teams.map((function(t){return i(t)})).map((function(t){return t.map((function(t){return t.map(I)}))}))),n=r.matches.map((function(t){return t.teams?t.teams.map(I):[]})).filter((function(t){return!e.reduce((function(e,n){return t&&n&&2===u(t,n).length||e}),!1)}));r.matches=r.matches.filter((function(t){var e=t.teams?t.teams.map(I):[];return!n.reduce((function(t,n){return 2===u(e,n).length||t}),!1)}))}(),(n=[]).concat.apply(n,r.teams.map((function(t){var e=i(t),n=r.matches.filter((function(t){return t.teams})).map((function(t){return a(t.teams)}));return e.filter((function(t){return n.indexOf(a(t))<0}))}))).reduce((function(t,e){return t.map(a).indexOf(a(e))<0&&t.push(e),t}),[]).forEach((function(t){var n,a=(n=[]).concat.apply(n,t),i={teams:t,players:a,round_name:"RR",bracket:e,ids:a.map((function(t){return t.id||t.id}))};r.matches.push(i)})),r.matches;function i(t){return r.teams.filter((function(e){return I(e)!==I(t)})).map((function(e){return[t,e]}))}}function _(t){return t&&t.matches&&t.matches.length?function(t){var e=function(t){return[].concat(Array(t)).map((function(t,e){return e}))},n=e(2*Math.round(t.players.length/2)+1).slice(1),r=e(n.length-1).map((function(){return[]})),a=n.slice(0,n.length/2),i=n.slice(n.length/2);return n.slice(1).forEach((function(t,e){var n,o;a.forEach((function(t,n){r[e].push([a[n],i[n]])}));var u=a.shift(),s=a.pop(),c=i.shift();a=(n=[]).concat.apply(n,[u,c].concat(a)),i=(o=[]).concat.apply(o,i.concat([s]))})),r.reverse()}(t):[]}function g(t,e){if(t.depth>=e&&(t._height=t.height,t.height=t.height=0),t.depth===e)return t._children=t.children||t._children,void(t.children=null);t.depth<e&&(t.children=t.children||t._children),t.children&&t.children.forEach((function(t){return g(t,e)}))}function y(t,n){var a;if(!t)return{};var i=e.tree(),o=e.hierarchy(t),u=t.maxTreeDepth||n;u&&g(o,u);var s=i(o).descendants(),c=Math.max.apply(Math,s.map((function(t){return t.depth}))),d=s.filter((function(t){return!t.height&&t.data.bye})),f=s.filter((function(t){return 0==+t.height&&t.depth!==c})),l=s&&s.filter((function(t){return W(t)}))||[],m=l.filter((function(t){return!X(t,!1)})),p=l.filter((function(t){return K(t)>1})),h=s.filter((function(e){return e&&e.children&&2===e.children.length&&(!t.max_round||e.height<=t.max_round)})),v=h.filter((function(t){return t&&t.children&&(function(t){return t&&t.children&&!M(t)&&t.children.map((function(t){return t.data.qualifier})).reduce((function(t,e){return e||t}),!1)}(t)||!W(t))})),_=s.map((function(t){return!!t.data.team&&t.data.team.length>1})).reduce((function(t,e){return t||e})),y=r(s.map((function(t){return t.data.dp}))).filter((function(t){return t})),w=s.filter((function(t){return!t.height&&t.data.qualifier})),b=s.filter((function(t){return!t.height&&t.data.team&&t.data.team[0]&&t.data.team[0].seed})).sort((function(t,e){return t.data.team[0].seed-e.data.team[0].seed})),E=s.filter(t.max_round?function(e){return+e.height==+t.max_round}:function(t){return 0==+t.depth}),I=l.filter((function(e){return t.max_round?+e.height==+t.max_round:!e.depth})).map((function(t){return t.data.team})),O=s.filter((function(t){return!(u||t.height||t.data.team||t.data.bye||t.data.qualifier)})),D=(a=[]).concat.apply(a,s.filter((function(t){return!t.height&&t.data.team&&!t.data.qualifier&&!t.data.bye})).map((function(t){return t.data.team.map((function(e){var n;return(n={})[e.id]=t.data.dp,n}))}))),S=D.length?Object.assign.apply(Object,D):{},k=h.length-d.length;function M(t){return t&&t.children&&t.children.map((function(t){return t.data.bye})).reduce((function(t,e){return e||t}),!1)}return{draw_type:"tree",complete:l.length&&l.filter((function(e){return!t.max_round||e.height<=t.max_round})).map((function(t){return M(t)||t.data.match&&t.data.match.complete})).reduce((function(t,e){return e&&t}),!0),draw_positions:y,assigned_positions:S,seeds:b,doubles:_,nodes:s,depth:c,total_matches:k,all_matches:h,match_nodes:l,upcoming_match_nodes:v,byes:d,bye_nodes:m,double_bye_nodes:p,structural_byes:f,qualifiers:w,final_round:E,final_round_players:I,unassigned:O}}function w(t){return t.matches&&t.matches.length&&t.matches.filter((function(t){return t.winner})).length===t.matches.length}function O(t){if(t){var e=(t>>>0).toString(2);return e.slice(1).length+(e.slice(1).indexOf(1)>=0?1:0)}}function D(t){var e=t.first_round_size,n=t.skip_rounds,r=t.feed_rounds;if(!e)return 0;var a,i=2*e-1,o=n&&n>0?e/(2*n):0,u=O(e),s=void 0!==r?u-(n||0)-r:0;return i-o-(void 0!==r&&s>0?(a=s,[].concat(Array(a)).map((function(t,e){return e}))).map((function(t){return Math.pow(2,t)})).reduce((function(t,e){return(t||0)+(e||0)})):0)}function S(t,n){if(t){if(t.brackets)return function(t){var n,r;t.brackets||(t.brackets=[]);var a=function(t){var n;return(n=[]).concat.apply(n,t.brackets.map((function(n,r){return e.range(t.bracket_size).map((function(t,e){return{bracket:r,position:e+1}}))})))}(t),i=t.brackets.length*t.bracket_size-t.opponents.length,o=(n=[]).concat.apply(n,t.brackets.map((function(t){return t.matches}))),u=function(t,e){return t+e},s=t.brackets.map((function(t){return(e=t.players.length,Array.from({length:e-0},(function(t,e){return e+0}))).reduce(u,0);var e})).reduce(u,0),c=(r=[]).concat.apply(r,t.seed_placements.map((function(t){return t.placements}))).map((function(t){return t.position})),d=t.seed_placements.filter((function(t){return t.range.length!==t.placements.length})),f=t.unseeded_placements?t.unseeded_placements.map((function(t){return t.position})):[],l=[].concat(c,t.bye_placements||[],f),m=function(t){return[t.bracket,t.position].join("|")},p=l.map(m),h=a.filter((function(t){return p.indexOf(m(t))<0})),v=t.brackets.map(w),_=v&&v.reduce((function(t,e){return t&&e})),g=f&&f.length&&t.unseeded_placements.length===t.unseeded_teams.length,y=[],b=[];if(d.length){var E=d[0].placements.map((function(t){return t.seed}));y=d[0].range.filter((function(t){return E.indexOf(t)<0})).map((function(e){return t.seeded_teams[e]}));var I=d[0].placements.map((function(t){return m(t.position)}));b=d[0].positions.filter((function(t){return I.indexOf(m(t))<0}))}return{draw_type:"roundrobin",draw_positions:a,matches:o,positions_filled:g,complete:_,byes:i,placements:l,unfilled_positions:h,total_matches:s,unfinished_seed_placements:d,unplaced_seeds:y,open_seed_positions:b}}(t);if(t.compass){var r=y(t[t.compass]);return r&&(r.compass=!0),r}return t.children?y(t,n):void 0}}function k(t,e){if(void 0===e&&(e=0),!isNaN(t)&&l(t))return Array.from(new Array(t),(function(t,e){return e+1})).map((function(t){return{dp:e+t}}))}function M(t,e){for(var n=t/T(t),r=t/n,a=1,i=[];a<=r;){var o=a%2;e&&a>1&&a<r&&(o=1-o),i.push(o?(a-1)*n+1:a*n),a+=1}return i}function T(t){if(N(t))return 0;for(var e=1;e<t&&!N(t-e);)e+=1;return e}function N(t){return!isNaN(t)&&t&&0==(t&t-1)}function x(t){for(var e=t.tree,n=t.byes,r=void 0===n?[]:n,a=t.fed,i=t.rounds,o=[],u=0;u<e.length;)if(r.indexOf(u+1)>=0)o.push(e[u]),u+=1;else{var s=e[u];s.fed=a,s.round=i;var c=e[u+1];c&&(c.fed=a,c.round=i);var d={children:[s,c],nuid:E.new()};o.push(d),u+=2}return o}function A(t,e,n,r){for(var a=[],i=0;i<t.length;){var o=e.pop();o.feed=!0,o.fed=n+1,o.round=r;var u=t[i];u.round=r,u.fed=n+1,a.push({children:[u,o]}),i+=1}return{round:a,remaining:e}}function C(t){var e,n=t.e,r=t.teams,a=t.structural_byes,i=t.offset,o=void 0===i?0:i,u=t.direction;if(Array.isArray(r))e=r.map((function(t,e){return{dp:o+e+1,team:t}}));else{if(isNaN(r)||!l(r))return;e=k(r,o)}for(e=x({e:n,tree:e,byes:a=a||M(e.length)});e.length>1;)e=x({e:n,tree:e});return u&&(e[0].direction=u),e[0]}function F(t){var e=t.node,n=t.position,r=t.team,a=void 0===r?[{}]:r,i=t.bye,o=t.qualifier,u=t.propagate,s=t.assigned;return e&&n&&(+e.dp!=+n||(e.team=a,e.team.forEach((function(t){t.draw_position=n,t.bye=i,t.qualifier=o,t.entry=t.entry?t.entry:o?"Q":""})),e.bye=i,e.qualifier=o,s=!0,u))&&e.children?e.children.map((function(t){return F({node:t,position:n,team:a,bye:i,qualifier:o,propagate:u,assigned:s})})).reduce((function(t,e){return t||e})):s}function U(t){var e,n=t.node,r=t.position;return+n.dp==+r?n:n.children?n.children.map((function(t){return t.dp})).indexOf(r)>=0?n:(e=[]).concat.apply(e,n.children.map((function(t){return U({node:t,position:r})}))).filter((function(t){return t}))[0]:void 0}function R(t){var e=t.draw,n=t.position,r=t.score,a=t.set_scores,i=t.matchFormat,o=t.bye,u=t.onlyIfBye,s=t.winner,c=U({node:e,position:n});if(c&&!c.dp)return P({draw:e,node:c,position:n,score:r,set_scores:a,matchFormat:i,bye:o,onlyIfBye:u,winner:s})}function j(t){return t.players&&t.players.reduce((function(t,e){return e&&t.indexOf(e.draw_position)<0?t.concat(e.draw_position):t}),[])||[]}function P(t){var e=t.draw,r=t.node,a=t.position,i=t.score,o=t.set_scores,s=t.complete,c=t.matchFormat,d=t.bye,f=t.onlyIfBye;if(!r)return{advanced:!1};r.match||(r.match={});var l=r.match,m=l&&l.round;if(r.dp&&m){var p=Array.isArray(e.matches)&&e.matches||n.matches(e)||[],h=j(l),v=p.filter((function(t){return t.round&&t.round===m+1||t.match&&t.match.round&&t.match.round===m+1})).reduce((function(t,e){return e.match&&u(j(e.match),h).length?e:t}),void 0),_=v&&v.match&&v.match.score,g=v&&j(v.match);if(_&&g.indexOf(+a)<0)return{advanced:!1,error:"Cannot change match outcome with subsequent match(es)"};if(_&&!s)return{advanced:!1,error:"Cannot enter an incomplete match score with subsequent matche(es)"}}var y=r.children.map((function(t){return t.dp})).indexOf(a),w=r.children.map((function(t){return t.team})).filter((function(t){return t})),b=w.reduce((function(t,e){return n.teamIsBye(e)||t}),!1);return 2===w.length&&y>=0?f&&!b||!d&&n.teamIsBye(w[y])?{advanced:!1}:(function(t,e){r.children.forEach((function(n,u){+n.dp==+a?(r.bye=e,r.dp=a,r.team=n.team,t||(r.match.score=i,r.match.winner_index=u,r.match.winner=n.team,r.match.set_scores=o,r.match.matchFormat=c)):t||(r.match.loser=n.team)}))}(n.teamIsBye(w[1-y]),d),{advanced:!0}):{advanced:!1}}function L(t){var e=t.total_players,n=t.evt,r=0,a=n&&n.seeds&&n.seeds<e&&n.seeds;return 0===a?0:(m.seed_limits.forEach((function(t){e>=t[0]&&(r=t[1])})),a||r)}function q(t,e){return Array.from(new Array(e),(function(e,n){return n+t}))}function B(t,e,n){return t[e].map((function(t){return+t[0]+n*t[1]}))}function V(t){var e=t.draw,r=t.group_index,a=e.compass?e[e.compass]:e;if(a.seed_placements&&a.seeded_teams){var i=void 0!==r?a.seed_placements[r]:G({draw:a});if(i){var o=i.positions.slice();a.bye_placements&&(o=o.filter((function(t){return a.bye_placements.indexOf(t)<0})));var u=[];i.range.forEach((function(t){var e=o.pop(),r=a.seeded_teams[t];if(!r)return i.positions=i.positions.filter((function(t){return+t!=+e})),void u.push(t);a.brackets?n.pushBracketTeam({draw:a,team:r,bracket_index:e.bracket,position:e.position}):F({node:a,position:e,team:r}),i.placements.push({seed:t,position:e})})),u.length&&u.forEach((function(t){return i.range=i.range.filter((function(e){return e!==t}))}))}}}function G(t){var e=t.draw,n=Q({draw:e.compass?e[e.compass]:e});return n?n[0]:void 0}function Q(t){var e=t.draw,n=e.compass?e[e.compass]:e;if(n.seed_placements&&Array.isArray(n.seed_placements))return n.seed_placements.filter((function(t){return t.range.length!==t.placements.length}))}function z(t){var e,r=t.draw,a=n.drawInfo(r),i=a.draw_positions.sort(O),o=a.structural_byes.map((function(t){return t.data.dp})),u=i.concat.apply(i,o).length,s=a.unassigned.map((function(t){return t.data.dp})).sort(O),c=s&&s.length||0;if(!c)return{};var d,f=function(t){var e=(void 0===t?{}:t).largestGroup,n=void 0===e||e,i=Object.keys(a.assigned_positions),o=r.opponents.filter((function(t){return i.indexOf(t[0].id)<0})),u={};o.forEach((function(t){var e=function(t){return t.map((function(t){return t.team})).sort().join("|")}(t);u[e]=u[e]?u[e].concat([t]):[t]}));var s=Object.keys(u).reduce((function(t,e){return u[e].length>t?u[e].length:t}),0),c=Object.keys(u).reduce((function(t,e){return u[e].length<t?u[e].length:t}),s),d=Object.keys(u).filter((function(t){return u[t].length===s})),f=Object.keys(u).filter((function(t){return u[t].length===c})),l=k(n?d:f);return{opponent:k(u[l])}}({largestGroup:E(s)}).opponent,l=Object.assign.apply(Object,[{}].concat((e=[]).concat.apply(e,r.opponents).map((function(t){var e;return(e={})[t.id]=t.team,e})))),m=Object.keys(a.assigned_positions).map((function(t){return{name:l[t],position:a.assigned_positions[t]}})),p=f.map((function(t){return t.team})),h=m.filter((function(t){return p.indexOf(t.name)>=0})).map((function(t){return t.position})),v=S(1,u+1),_=S(2,u).filter((function(t){return t===Math.pow(2,Math.round(Math.log(t)/Math.log(2)))})).reverse().map((function(t){return e=t,v.reduce((function(t,n,r){var a=Math.floor(r/e);return t[a]=[].concat(t[a]||[],n),t}),[]);var e})).map((function(t){return t.map(I)})).map((function(t){return t.filter((function(t){return!t.group_present}))})).filter((function(t){return t})),g=_.map((function(t){return t.filter((function(t){return t.unpaired.length})).map((function(t){return t.unpaired}))})).filter((function(t){return t&&t.length})),y=_.map((function(t){return t.filter((function(t){return t.unassigned.length})).map((function(t){return t.unassigned}))})).filter((function(t){return t&&t.length})),w=g.length&&g[0]||y.length&&y[0];if(w){var b=k(w);d=k(b)}else d=k(s);return{opponent:f,position:d,remaining:c};function E(t){var e=t.map(D);return t.filter((function(t){return!function(t){var n=D(t);return e.indexOf(n%2?n+1:n-1)<0}(t)}))}function I(t){var e=s.filter((function(e){return t.indexOf(D(e))>=0}));return{unassigned:e,unpaired:E(e),group_present:h.reduce((function(e,n){return t.indexOf(D(n))>=0||e}),!1)}}function O(t,e){return t-e}function D(t){var e=t+o.filter((function(e){return e<t})).length;return o.indexOf(t)>=0&&!(1&t)?e+1:e}function S(t,e){return Array.from({length:e-t},(function(e,n){return n+t}))}function k(t){return t.length?t.splice(Math.floor(Math.random()*t.length),1)[0]:void 0}}function W(t){var e=H(t);return 2===e.length&&e}function H(t){return!!(t&&t.data&&t.data.children)&&(t.data.children.forEach((function(t){t&&t.team&&t.dp&&t.team[0]&&t.team[0].draw_position!==t.dp&&t.team.forEach((function(e){return e.draw_position=t.dp}))})),t.data.children.map((function(t){return t.team})).filter((function(t){return t})))}function Y(t){return!!(t&&t.data&&t.data.children)&&1===t.data.children.map((function(t){return t.feed})).filter((function(t){return t})).length}function K(t){if(!t.children)return!1;var e=t.data.children.map((function(t){return t.bye})).filter((function(t){return t}));return e.length?e.length:void 0}function X(t,e){if(void 0===e&&(e=!0),!t.children)return!1;var n=W(t);if(!n)return!1;var r=t.data.children.map((function(t){return!(t.bye||t.qualifier&&e)})).filter((function(t){return t}));return!(r.length<2)&&!!r.reduce((function(t,e){return t&&e}))&&n}function Z(t,e){var r=S(t),a=(r&&r.match_nodes||[]).filter((function(t){return n.teamMatch(t)})).filter((function(t){var n=t.data.children.map((function(t){return t.team?t.team[0].draw_position:void 0}));return 2===u(e,n).length}));return a.length?a[0].data:void 0}function J(t){var e=t.max_round,n=t.round_offset,r=void 0===n?0:n,a=t.round_names,i=void 0===a?[]:a,o=t.calculated_round_names,u=void 0===o?[]:o,s=t.potentials,c=t.draw;return t.match_nodes.filter((function(t){return s||X(t)})).filter((function(t){return!e||t.height<=e})).map((function(t){var e=i.length?i[t.depth-r]:void 0;e&&(t.data.round_name=e);var n=u.length?u[t.depth-r]:void 0;n&&(t.data.calculated_round_name=n),t.data.match&&e&&(t.data.match.round_name=e);var a=t.data.children.filter((function(t){return!t.team})).map((function(t){return t.children?t.children.map((function(t){return t.team})):void 0})),o=t.data.children.filter((function(t){return!t.team})).map((function(t){return t.match&&t.match.muid})),s={dependent:t.parent&&t.parent.data&&t.parent.data.match&&t.parent.data.match.muid,round_name:e,potentials:a,dependencies:o,source:t,round:t.height,calculated_round_name:n,match:t.data.match,teams:t.data.children.map((function(t){return t.team})).filter((function(t){return t}))};return c&&(s.draw=c),s}))}t&&nt(t,m),n.options=function(t){if(!t)return m;nt(t,m)},n.acceptedDrawSizes=p,n.standardDrawSize=h,n.treeDrawMatchOrder=function(t){return tt(t).filter((function(t){return t.match})).sort((function(t,n){return e(t)-e(n)})).map((function(t){return t.match.muid}));function e(t){return t.teams&&Array.isArray(t.teams)&&t.teams.length&&t.teams.reduce((function(t,e){return e&&e[0]&&e[0].draw_position||t}),void 0)||1e3}},n.bracketMatches=v,n.roundRobinRounds=function(t){var e=t.event,n=e&&e.draw;if(n&&n.brackets&&n.brackets.length){for(var r=[],a=n.brackets.map(_),i=e&&e.links&&e.links.E,o=Math.max.apply(Math,a.map((function(t){return t.length}))),u=function(t){r.push(a.map((function(e,n){return{bracket:n,matchups:c(n,e[t])}})).filter((function(t){return t.matchups})))},s=0;s<o;s++)u(s);return r.forEach((function(t,e){t.forEach((function(t){t.matchups.forEach((function(t){t.round=e+1,t.round_name="RR"+(i?"Q":"")+(e+1)}))}))})),r}function c(t,e){if(e){var r=n.brackets[t].matches,a=e.map((function(t){return t.sort().join("|")}));return r.filter((function(t){return a.indexOf(t.players.map((function(t){return t.draw_position})).sort().join("|"))>=0}))}}},n.bracketRounds=_,n.compassInfo=function(t){var e,n=0,r=[],a=[],i=[],o=[];return["east","west","north","south","northeast","northwest","southeast","southwest"].filter((function(e){return t[e]})).forEach((function(u){var s,c,d,f,l=y(t[u]);e=e||l.complete,n+=l.total_matches,r=(s=r).concat.apply(s,l.all_matches),a=(c=a).concat.apply(c,l.match_nodes),i=(d=i).concat.apply(d,l.upcoming_match_nodes),o=(f=o).concat.apply(f,l.unassigned)})),{complete:e,total_matches:n,all_matches:r,match_nodes:a,upcoming_match_nodes:i,unassigned:o}},n.collapseHierarchy=g,n.expandHierarchy=function t(e){e.children=e.children||e._children,e.height=e.height||e._height,e._children=null,e._height=null,e.children&&e.children.forEach((function(e){return t(e)}))},n.replaceDrawPlayer=function(t,e,r){if(t&&e&&r&&"object"==typeof r){t.opponents&&t.opponents.forEach((function(t){t.forEach(i)})),t.seeded_teams&&Object.keys(t.seeded_teams).forEach((function(e){return t.seeded_teams[e].forEach(i)})),t.unseeded_teams&&t.unseeded_teams.forEach((function(t){t.forEach(i)})),t.unseeded_placements&&t.unseeded_placements.forEach((function(t){t.id===e.id&&(t.id=r.id)}));var a=[];t.dual_matches?Object.keys(t.dual_matches||{}).forEach((function(e){var n,r=t.dual_matches[e].matches||[];r.forEach((function(t){return t.dual_match=e})),a=(n=a).concat.apply(n,r)})):a=n.matches(t).filter((function(t){return t.match&&t.match.muid})),a.forEach((function(t){t.teams&&t.teams.filter((function(t){return t})).forEach((function(t){return t.forEach(i)})),t.winner&&t.winner.forEach(i),t.loser&&t.loser.forEach(i),t.players&&t.players.forEach(i),t.ids&&(t.ids=t.players.map((function(t){return t.id}))),t.match&&(t.match.teams&&t.match.teams.forEach((function(t){return t.forEach(i)})),t.match.winner&&Array.isArray(t.match.winner)&&t.match.winner.forEach(i),t.match.loser&&Array.isArray*t.match.loser&&t.match.loser.forEach(i),t.match.players&&t.match.players.forEach(i),t.match.ids&&(t.match.ids=t.match.players.map((function(t){return t.id}))))})),t.brackets&&t.brackets.forEach((function(t){return t.players.forEach(i)}))}function i(t){!t||t.id!==e.id&&t.id!==e.id||Object.keys(r).forEach((function(e){return t[e]=r[e]}))}},n.bracketComplete=w,n.drawRounds=O,n.calcFeedBase=function(t){var e=t.draw_positions,n=e&&e.length;if(N(n)||(n+=T(n)),n&&N(n))return n/2},n.feedDrawSize=function(t){for(var e=t.num_players,n=t.skip_rounds,r=t.feed_rounds,a=0,i=0;D({first_round_size:d[a],skip_rounds:n,feed_rounds:r})<e&&i<10;)i+=1,a+=1;return i>=10?(console.log("BOOM!",e,n,r),d[1]):d[a]},n.calcFeedSize=D,n.drawInfo=S,n.blankDraw=k,n.addByes=function(t){var e=S(t),n=e.draw_positions,r=n.length?Math.max.apply(Math,n):0;!function t(n,a){void 0===a&&(a=0),a<e.depth&&!n.children&&function(t,e){void 0===e&&(e=1);var n={bye:!0,team:[{draw_position:"",bye:!0}]},r={dp:t.dp,id:t.id,team:t.team};t.children=e?[r,n]:[n,r],t.match={score:""}}(n,n.team&&n.team[0].draw_position>=r/2?0:1),n.children&&n.children.forEach((function(e){return t(e,a+1)}))}(t)},n.structuralByes=M,n.sByes=T,n.dispersion=function(t,e){for(var n,r=[],a=t;n=a,!isNaN(n)&&n/2===Math.floor(n/2);)r.push(a),a/=2;var i=0,o=[];return r.forEach((function(n){+i==+e&&(o.push(n),o.push(t-n+1)),i+=1})),o.sort((function(t,e){return t-e})),o},n.feedRound=A,n.feedInDraw=function(t){var e=t.e,n=t.teams,r=t.skip_rounds,a=void 0===r?0:r,i=t.feed_rounds,o=void 0===i?0:i,u=t.offset,s=Array.isArray(n)?n.length:n;if(!(s<2)){a>=O(n)&&(o=0);for(var c=k(Math.pow(2,Math.ceil(Math.log(s+1)/Math.log(2))),u),d=c.slice(c.length/2).reverse(),f=x({e:e,tree:c.slice(0,c.length/2)}),l=0;f.length>1&&a>0;)f=x({e:e,tree:f}),a-=1,l+=1;var m=0;if(f.length>1&&m<o){var p=A(f,d,m,l);f=p.round,d=p.remaining,m+=1}for(;f.length>1;)if(f=x({e:e,tree:f,fed:m,rounds:l}),l+=1,f.length>1&&m<o){if(m>=a){var h=A(f,d,m,l);f=h.round,d=h.remaining}m+=1}if(m<o){var v=A(f,d,m,l);f=v.round,d=v.remaining}return f&&f.length?f[0]:f}},n.buildDraw=C,n.buildQualDraw=function(t){var n=t.e,r=t.num_qualifiers,a=h(Math.ceil(t.num_players/r)),i=Array.from(new Array(r),(function(t,e){return e})).map((function(t,e){return C({e:n,teams:a,offset:e*a})}));return{children:i,max_round:e.hierarchy(i[0]).height}},n.assignPosition=F,n.findPositionNode=U,n.advancePosition=R,n.teamIsBye=function(t){return t.map((function(t){return t.bye})).reduce((function(t,e){return t&&e}))},n.advanceToNode=P,n.modifyPositionScore=function(t){var e=t.score,n=t.set_scores,r=t.complete,a=t.matchFormat,i=Z(t.node,t.positions);i&&(i.match||(i.match={}),i.match.score=e,i.match.set_scores=n,i.match.matchFormat=a,void 0!==r&&(i.match.complete=r),r||(delete i.team,delete i.match.loser,delete i.match.winner,delete i.match.winner_index))},n.schedulePosition=function(t){var e=t.schedule,n=t.venue,r=U({node:t.node,position:t.position});r.match||(r.match={}),r.match.schedule=e,r.match.venue=n},n.seedBlock=function(t){var e=m.seedBlocks.reduce((function(e,n){if(n)return t>=n[0]&&t<=(n[1]||n[0])?n:e}),void 0);return e&&e.join("-")},n.seedLimit=L,n.roundrobinSeedPlacements=function(t){var n=t.draw,r=t.bracket_size,a=[],i=n.brackets.length,o=Object.keys(n.seeded_teams),u=o.slice(0,i),s=o.slice(i);e.range(u.length).forEach((function(t){a.push({range:[t+1],positions:[{bracket:t%i,position:1}],placements:[]})}));var c=[],d=[];return e.range(i).forEach((function(t){var e=u.length+t;t<s.length&&c.push(e+1),d.push({bracket:e%i,position:r})})),e.shuffle(d),a.push({range:c,positions:d,placements:[]}),a},n.qualifyingBracketSeeding=function(t){var n=t.draw,r=t.qualifiers,a=h(Math.ceil(t.num_players/r)),i=[],o=Object.keys(n.seeded_teams),u=o.slice(0,r),s=o.slice(r);e.range(u.length).forEach((function(t){i.push({range:[t+1],placements:[],positions:[t%r*a+1]})}));var c=[],d=[];return e.range(s.length).forEach((function(t){c.push(u.length+t+1)})),e.range(u.length).forEach((function(t){d.push(t%r*a+a)})),e.shuffle(d),i.push({range:c,positions:d,placements:[]}),i},n.validSeedPlacements=function(t){var n=t.num_players,r=t.random_sort,a=void 0!==r&&r,i=t.seed_limit,o=1,u=[],s=p({num_players:n,standardSizes:t.qualifying_draw});for(i=i||L({total_players:n||s});o<=i;){var c=B(m.seedPositions,o,s);a&&e.shuffle(c),u.push({range:q(o,c.length),positions:c,placements:[]}),o+=c.length||s}return u},n.distributeByes=function(t){var e=t.draw,n=t.num_players,r=t.target_byes,a=e.compass?e[e.compass]:e,i=S(a),o=i.seeds.map((function(t){return t.data.dp}));n=n||(a.opponents?a.opponents.length:0)+(a.qualifiers||0);var c=i.draw_positions.map((function(){})).slice(n),d=i.nodes.filter((function(t){return 1==+t.height&&t.children})).map((function(t){var e;return(e=[]).concat.apply(e,t.children.map((function(t){return t.data.dp})))})),f=d.filter((function(t){return u(o,t).length<1})),l=d.filter((function(t){return u(o,t).length>0})),p=i.draw_positions.length,h=r||m.bye_placement&&p&&m.bye_placement[p]||{};if(i.structural_byes.length){var v,_=i.structural_byes.map((function(t){return t.parent.children.filter((function(t){return t.data.children}))})).map((function(t){return t[0].data.children.map((function(t){return t.dp}))})),g=i.structural_byes.map((function(t){return t.data&&t.data.team?t.data.team[0].seed:void 0})),y=[];m.compressed.byes_adjacent_to_seeds&&g.filter((function(t){return t})).forEach((function(t,e){return y[t-1]=_[e]})),y.filter((function(t){return t}));var w=c.map((function(t,e){return y[e]?y[e][Math.floor(2*Math.random())]:void 0})),b=f.filter((function(t){return!u(t,w).length})),E=(v=[]).concat.apply(v,b);c=r?c.map((function(t,e){return r[e]})):w.map((function(t){return t||!!b.length&&T(b)})).filter((function(t){return t})),f=f.filter((function(t){return!u(t,E)}))}else if(h&&h.length>=c.length)c=c.map((function(t,e){return h[e]}));else{var I,O,D=a.seed_placements?(I=[]).concat.apply(I,a.seed_placements.map((function(t){return t.placements}))).map((function(t){return t.position})):[],k=c.map((function(t,e){return l.filter((function(t){return t.indexOf(o[e])>=0}))[0]}));c=(O=[]).concat.apply(O,k).filter((function(t){return D.indexOf(t)<0}))}var M=c.map((function(t){return t||T(f)}));return M.forEach((function(t,e){F({node:a,position:t,bye:e+1})})),a.bye_placements=M,M;function T(t){var e=s(t),n=Math.floor(2*Math.random());if(e)return e[n];console.log({error:"unable to pop",source:t})}},n.rrByeDistribution=function(t){var n=t.draw,r=n.brackets.length*n.bracket_size-n.opponents.length;if(r>n.brackets.length)return!1;n.bye_placements=e.range(r).map((function(t,e){return n.brackets[e].byes=[{position:2}],{bracket:e,position:2}}))},n.rrUnseededPlacements=function(t){var e=t.draw;m.separation.team?function(t){var e=t.draw,r=!1,a=n.drawInfo(e).unfilled_positions;e.unseeded_placements||(e.unseeded_placements=[]);for(var i=function(){var t,n=s(a),i=(t=e.brackets[n.bracket])&&t.players?t.players.map((function(t){return t.team})):[],u=function(t){var e,n=t.unseeded_placements?(e=[]).concat.apply(e,t.unseeded_placements.map((function(t){return t.team.map((function(t){return t.id}))}))):[];return t.unseeded_teams.filter((function(t){return n.indexOf(t[0].id)<0}))}(e),c=u.filter((function(t){return i.indexOf(t[0].team)<0}));m.separation.team&&c.length?o(s(c),n):u.length?o(s(u),n):(console.log("ERROR"),r=!0)};a.length&&!r;)i();function o(t,r){n.pushBracketTeam({draw:e,team:t,bracket_index:r.bracket,position:r.position}),e.unseeded_placements.push({team:t,position:r})}}({draw:e}):function(t){var e=t.draw,r=n.drawInfo(e).unfilled_positions;e.unseeded_placements=e.unseeded_teams.map((function(t){var a=s(r);return n.pushBracketTeam({draw:e,team:t,bracket_index:a.bracket,position:a.position}),{team:t,position:a}}))}({draw:e})},n.distributeQualifiers=function(t){var n=t.draw,r=t.num_qualifiers,a=n.compass?n[n.compass]:n,i=S(a),o=i.draw_positions.length,c=i.unassigned.map((function(t){return t.data.dp})),d=e.range(0,r=r||a.qualifiers||0).map((function(){return[{entry:"Q",qualifier:!0}]})).reverse(),f=Math.floor(o/r),l=e.range(0,Math.floor(o/f));e.range(0,r).forEach((function(){var t=s(l),n=e.range(t*f+1,t*f+f+1),r=u(n,c),i=Math.floor(2*Math.random())?r.shift():r.pop();if(i){var o=d.pop();F({node:a,position:i,team:o,qualifier:!0})}})),d.forEach((function(t){var e=(i=S(a)).unassigned.map((function(t){return t.data.dp})).pop();F({node:a,position:e,team:t,qualifier:!0})}))},n.seededTeams=function(t){return Object.assign.apply(Object,[{}].concat(t.teams.filter((function(t){return t[0].seed})).sort((function(t,e){return t[0].seed-e[0].seed})).map((function(t){var e;return(e={})[t[0].seed]=t,e}))))},n.placeSeedGroups=function(t){var n=t.draw,r=t.count,a=n.compass?n[n.compass]:n;a.seed_placements&&a.seeded_teams&&e.range(0,r=r||a.seed_placements.length).forEach((function(){return V({draw:a})}))},n.placeSeedGroup=V,n.pushBracketTeam=function(t){var e=t.draw,n=t.team,r=t.bracket_index,a=t.position,i=n[0];i.draw_position=a,e.brackets[r].players.push(i),n.forEach((function(t){return t.draw_position=a})),e.brackets[r].teams.push(n)},n.nextSeedGroup=G,n.unplacedSeedGroups=Q,n.roundMatches=function(t){var e=t.info,n=t.round,r=e&&e.all_matches;return void 0!==n&&r&&r.filter((function(t){return t.height===n&&!K(t)})).length||0},n.placeUnseededTeams=function(t){var e=t.draw,n=e.compass?e[e.compass]:e;n.unseeded_teams&&(m.separation.team&&e.opponents?function(t){for(var e=t.draw,n=z({draw:e}),r=n.opponent,a=n.position,i=n.remaining,o=0;o<i;o++){r&&F({node:e,position:a,team:r});var u=z({draw:e});r=u.opponent,a=u.position}}({draw:n}):function(t){var e=t.draw;S(e).unassigned.map((function(t){return t.data.dp})).forEach((function(t){var n=s(e.unseeded_teams);n&&F({node:e,position:t,team:n})}))}({draw:n}))},n.matchNodes=function(t){return S(t).match_nodes},n.matchNode=W,n.matchTeams=H,n.feedNode=Y,n.feedNodes=function(t){return t.filter(Y)},n.byeTeams=function(t){if(!t.data.children)return!1;var e=W(t);if(!e)return!1;var n=t.data.children.map((function(t){return t.bye})).filter((function(t){return t}));return!!n.length&&!!n.reduce((function(t,e){return t&&e}))&&e},n.byeNode=K,n.teamMatch=X,n.drawPositionsWithBye=function(t){var e;return r((e=[]).concat.apply(e,t.map((function(t){var e;return(e=[]).concat.apply(e,t.map((function(t){return t.map((function(t){return t.bye?void 0:t.draw_position}))})))})))).filter((function(t){return t}))},n.replaceEmptiesWithByes=function(t){var e=t.draw,n=S(e),r=n&&Object.keys(n.assigned_positions).map((function(t){return n.assigned_positions[t]}))||[];(n&&n.draw_positions||[]).filter((function(t){return r.indexOf(t)<0})).forEach((function(t){F({node:e,position:t,bye:!0})}))},n.advanceTeamsWithByes=function t(e){var n,r=e.draw,a=S(r),i=a.match_nodes.filter((function(t){return!t.data.team})).filter((function(t){return t.children.reduce((function(t,e){return e.data.bye||t}),void 0)})),o=(n=[]).concat.apply(n,i.map((function(t){return t.children.map((function(t){return t.data.dp}))}))),u=a.byes.map((function(t){return t.data.dp}));o.filter((function(t){return u.indexOf(t)<0})).forEach((function(t){return R({draw:r,position:t,onlyIfBye:!0})})),a.bye_nodes&&a.bye_nodes.forEach((function(t){t.data&&t.data.match&&delete t.data.match.schedule}));var s=a.double_bye_nodes.filter((function(t){return!((e=t).data&&e.data.team&&e.data.team.reduce((function(t,e){return e.bye||t}),void 0));var e})).map((function(t){return t.data.children[0].dp}));if(s.forEach((function(t){R({draw:r,position:t,bye:!0,onlyIfBye:!0})})),s.length)return t({draw:r})},n.findDualMatchNodeByMatch=function(t,e){var r=n.findDualMatchMuid(t,e);return n.findDualMatchNode(t,r)},n.findDualMatchNode=function(t,e){var n=t&&S(t);return n&&n.match_nodes&&n.match_nodes.reduce((function(t,n){return n.data.match&&n.data.match.muid===e?n:t}),void 0)},n.findDualMatchMuid=function(t,e){return t.dual_matches&&Object.keys(t.dual_matches).reduce((function(n,r){return t.dual_matches[r].matches.reduce((function(t,n){return n.match.muid===e?n:t}),void 0)?r:n}),void 0)},n.findRRDualMatch=function(t,e){var r=n.findDualMatchMuid(t,e);return n.matches(t).reduce((function(t,e){return e.match.muid===r?e:t}),void 0)},n.findMatchNodeByTeamPositions=Z,n.upcomingMatches=function(t,e,n){if(void 0===e&&(e=[]),void 0===n&&(n=[]),!t)return[];if(t.compass)return function(t){var e;return(e=[]).concat.apply(e,Object.keys($.pre).filter((function(e){return t[e]})).map((function(e){var n=S(t[e]),r=t[e].max_round,a=r?n.depth-r:0,i=$.names.map((function(t){return $.pre[e]+"-"+t}));return J({match_nodes:n.upcoming_match_nodes,max_round:r,round_offset:a,round_names:i,potentials:!0})}))).filter((function(t){return t&&t.match}))}(t);var r=S(t);return r&&"tree"===r.draw_type?J({match_nodes:r.upcoming_match_nodes,max_round:t.max_round,round_offset:t.max_round?r.depth-t.max_round:0,round_names:e,calculated_round_names:n,potentials:!0}):[]},n.treeMatches=J;var $={pre:{east:"E",west:"W",north:"N",south:"S",northeast:"NE",northwest:"NW",southeast:"SE",southwest:"SW"},names:["F","SF","QF","R16","R32","R64","R128","R256","R512"]};function tt(t,e,n,r){if(void 0===e&&(e=[]),void 0===n&&(n=[]),!t)return[];if(t.compass)return function(t,e){var n;return(n=[]).concat.apply(n,Object.keys($.pre).filter((function(e){return t[e]})).map((function(n){var r=S(t[n]),a=t[n].max_round,i=a?r.depth-a:0,o=$.names.map((function(t){return $.pre[n]+"-"+t}));return J({match_nodes:e?r.all_matches:r.match_nodes,max_round:a,round_offset:i,round_names:o,potentials:e,draw:n})})))}(t,r);var a,i=S(t);return i?"tree"===i.draw_type?J({match_nodes:r?i.all_matches:i.match_nodes,max_round:t.max_round,round_offset:t.max_round?i.depth-t.max_round:0,round_names:e,calculated_round_names:n,potentials:r}):"roundrobin"===i.draw_type?(t.brackets.forEach((function(e,n){return v(t,n)})),(a=[]).concat.apply(a,t.brackets.map((function(t){return t.matches}))).map((function(t){return{teams:t.teams||t.players.map((function(t){return[t]})),round_name:t.round_name,result_order:t.result_order,match:t}}))):[]:t.matches||[]}function et(t){var e=t.matches,n=t.per_player,u=t.qualifying,s=t.matchFormat,d=o.parse(s)||{};e&&e.length&&e.filter((function(t){return t.winner})).length===e.length||(n=0);var f=[],l={},p={},h=m.rr_h2h_priority;if(e){e.filter((function(t){return t})).forEach((function(t){var e=o.parse(t.matchFormat||s)||{};if(t.winner&&t.loser){var n=E(t.winner),r=E(t.loser);if(!n||!r){var a=t.teams&&t.teams[0]&&E(t.teams[0]),i=t.teams&&t.teams[1]&&E(t.teams[1]);return a&&(O(a),l[a].matches_cancelled+=1),void(i&&(O(i),l[i].matches_cancelled+=1))}O(n),O(r),t.score&&S(t.score)&&f.push(r),l[n].matches_won+=1,l[r].matches_lost+=1,l[r].defeats.push(n),l[n].victories.push(r);var u=k(t.score,0,e);l[n].sets_won+=u[0],l[n].sets_lost+=u[1],l[r].sets_won+=u[1],l[r].sets_lost+=u[0];var c=function(t,e,n){var r=b.setsToWin(n.bestOf),a=n.setFormat&&n.setFormat.setTo,i=n.setFormat&&n.setFormat.tiebreakAt;if(!t)return[0,0];var o=r*a,u=[[],[]];if(S(t)?r&&a&&u[0].push(o):t.split(" ").forEach((function(t){var e=/\d+[\(\)\-\/]*/.test(t)&&t.indexOf("-")>0?t.split("-").map((function(t){return/\d+/.exec(t)[0]})):void 0;e&&(u[0].push(parseInt(e[0])),u[1].push(parseInt(e[1])))})),D(t)&&r&&a){var s=k(t,0,n),c=s.reduce((function(t,e){return t+e}),0);if(u.map((function(t){return t[0]<=t[1]})).reduce((function(t,e){return t+e}),0)>s[1]){var d=u[0].length,f=function(t){if(n&&""!==t)return+t==i-1||+t===i?parseInt(i||0)+1:+t<i?a:i}(u[1][d-1]);f&&(u[0][d-1]=f)}c>u[0].length&&u[0].push(a)}var l=[u[0].reduce((function(t,e){return t+e}),0),u[1].reduce((function(t,e){return t+e}),0)];return l[0]<o&&(l[0]=o),l}(t.score,0,e);l[n].games_won+=c[0],l[n].games_lost+=c[1],l[r].games_won+=c[1],l[r].games_lost+=c[0];var d=function(t){var e=[0,0];return t?(t.split(" ").forEach((function(t){var n=/\d+\/\d+/.test(t)?t.split("/").map((function(t){return/\d+/.exec(t)[0]})):[0,0];n&&(e[0]+=parseInt(n[0]),e[1]+=parseInt(n[1]))})),e):e}(t.score);l[n].points_won+=d[0],l[n].points_lost+=d[1],l[r].points_won+=d[1],l[r].points_lost+=d[0]}else t.teams&&t.teams.forEach((function(t){return O(E(t))}))}));var v=b.setsToWin(d.bestOf),_=d.setFormat&&d.setFormat.setTo;Object.keys(l).forEach((function(t){var e=l[t].sets_won,r=n*(v||0)||e,a=Math.round(e/l[t].sets_lost*1e3)/1e3;(Infinity===a||isNaN(a))&&(a=r);var i=l[t].matches_won,o=Math.round(i/l[t].matches_lost*1e3)/1e3;(Infinity===o||isNaN(o))&&(o=i);var u=l[t].games_won,s=l[t].games_lost,c=n*(v||0)*(_||0)||u,d=Math.round(u/s*1e3)/1e3;(Infinity===d||isNaN(d))&&(d=c);var f=s>=u?0:u-s,m=Math.round(l[t].points_won/l[t].points_lost*1e3)/1e3;(Infinity===m||isNaN(m))&&(m=0),l[t].sets_ratio=a,l[t].matches_ratio=o,l[t].games_ratio=d,l[t].games_difference=f,l[t].points_ratio=m,l[t].result=l[t].matches_won+"/"+l[t].matches_lost,l[t].games=l[t].games_won+"/"+l[t].games_lost}));var g=function(t){var e=Object.keys(t),n=e.length,i=e.reduce((function(e,n,r){return e.push({id:n,i:r,results:t[n]}),e}),[]).filter((function(t){return n-1===t.results.matches_won+t.results.matches_lost+t.results.matches_cancelled}));if(n===i.length){if(i.forEach((function(t){return t.order_hash=function(t){return f.indexOf(t.id)>=0?0:b(t)}(t)})),i.forEach((function(t){return t.ratio_hash=b(t)})),h){i.sort((function(t,e){return(e.results.matches_won||0)-(t.results.matches_won||0)}));var o=i.map((function(t){return t.results.matches_won}));r(o).forEach((function(t){var e=a(t,o);if(e.length&&e.length>1){var n=Math.min.apply(Math,e),r=Math.max.apply(Math,e)-n+1;i=c(i,n,r,2===r?w:g)}}))}else i.sort(g);var u=r(i.map((function(t){return t.order_hash})));i.forEach((function(t){return t.hash_order=u.indexOf(t.order_hash)+1}));var s=0,d=void 0;if(i.forEach((function(t,e){t.order_hash!==d&&(s=e+1,d=t.order_hash),t.rank_order=s})),h){i.sort((function(t,e){return(e.results.matches_won||0)-(t.results.matches_won||0)}));var l=i.map((function(t){return t.results.matches_won}));r(l).forEach((function(t){var e=a(t,l);if(e.length&&e.length>1){var n=Math.min.apply(Math,e),r=Math.max.apply(Math,e)-n+1;i=c(i,n,r,2===r?y:_)}}))}else i.sort(_);var m=r(i.map((function(t){return t.ratio_hash})));i.forEach((function(t){return t.ratio_order=m.indexOf(t.ratio_hash)+1}));var p=0,v=void 0;return i.forEach((function(t,e){t.ratio_hash!==v&&(p=e+1,v=t.ratio_hash),t.points_order=p})),i}function _(t,e){return e.ratio_hash-t.ratio_hash}function g(t,e){return e.order_hash-t.order_hash}function y(t,e){var n=t.results.victories.indexOf(e.id)>=0,r=e.results.victories.indexOf(t.id)>=0;return n||r?r?1:-1:e.ratio_hash-t.ratio_hash}function w(t,e){var n=t.results.victories.indexOf(e.id)>=0,r=e.results.victories.indexOf(t.id)>=0;return n||r?r?1:-1:e.order_hash-t.order_hash}function b(t){return h?t.results.matches_ratio*Math.pow(10,16)+t.results.sets_ratio*Math.pow(10,12)+t.results.games_difference*Math.pow(10,8)+t.results.points_ratio*Math.pow(10,3):t.results.matches_ratio*Math.pow(10,16)+t.results.sets_ratio*Math.pow(10,12)+t.results.games_ratio*Math.pow(10,8)+t.results.points_ratio*Math.pow(10,3)}}(l);if(g){var y=g.map((function(t){return t.rank_order}));g.forEach((function(t){l[t.id].ratio_hash=t.ratio_hash,void 0!==t&&void 0!==t.rank_order&&(l[t.id].qorder=t.rank_order,i(t.rank_order,y)>1&&void 0===l[t.id].sub_order?l[t.id].sub_order=0:1===i(t.rank_order,y)&&(l[t.id].sub_order=void 0)),l[t.id].points_order=void 0!==t&&void 0!==t.points_order?t.points_order:void 0}))}var w=Object.keys(l).reduce((function(t,e){return t[e]=l[e].points_order,t}),{});return e.forEach((function(t){var e=void 0===t.winner_index?"":w[E(t.winner)];p[t.muid]="RR"+(u?"Q":"")+(e||"")})),{team_results:l,match_result_order:p}}function E(t){return!Array.isArray(t)&&t.players&&t.id?t.id:I(t)}function O(t){l[t]||(l[t]={matches_won:0,matches_lost:0,victories:[],defeats:[],matches_cancelled:0,sets_won:0,sets_lost:0,games_won:0,games_lost:0,points_won:0,points_lost:0})}function D(t){return/RET/.test(t)}function S(t){return function(t){return/W/.test(t)&&/O/.test(t)}(t)||function(t){return/DEF/.test(t)}(t)}function k(t,e,n){var r=b.setsToWin(n.bestOf),a=[0,0];return t?(S(t)?void 0!==e&&r&&(a[e]=r):t.split(" ").forEach((function(t){var e=t.indexOf("-")>0?"-":t.indexOf("/")>0?"/":void 0,n=/\d+[\(\)\-\/]*/.test(t)&&e?t.split(e).map((function(t){return/\d+/.exec(t)[0]})):void 0;n&&(a[parseInt(n[0])>parseInt(n[1])?0:1]+=1)})),D(t)&&void 0!==e&&r&&(+a[1-e]===r&&(a[1-e]-=1),a[e]=r),a):a}}function nt(t,e){if(t&&e)for(var n=Object.keys(t),r=Object.keys(e),a=0;a<n.length;a++)if(r.indexOf(n[a])>=0){var i=e[n[a]];i&&"object"==typeof i&&"function"!=typeof t[n[a]]&&i.constructor!==Array?nt(t[n[a]],e[n[a]]):e[n[a]]=t[n[a]]}}return n.extractDrawPlayers=function(t){var e,r=[],a=[];return(e=[]).concat.apply(e,n.drawInfo(t).nodes.map((function(t){return t.data&&t.data.team}))).forEach((function(t){a.indexOf(t.draw_position)<0&&(a.push(t.draw_position),r.push(t))})),r},n.matches=tt,n.tallyBracketAndModifyPlayers=function(t){var e=t.matches,n=t.teams,r=t.per_player,a=t.reset;if(e&&e.length){var i=et({matches:e,per_player:r=r||n&&n.length-1||1,qualifying:t.qualifying,matchFormat:t.matchFormat}),o=Object.keys(i.team_results).map((function(t){return i.team_results[t].qorder})).reduce((function(t,e){return!t[e]++&&(t[e]=1),t}),{}),u=Object.keys(o).reduce((function(t,e){return o[e]>1?t.concat(parseInt(e)):t}),[]);return e.forEach((function(t){return t.results_order=i.match_result_order[t.muid]})),n.forEach((function(t){var e=I(t);i.team_results[e]&&t.forEach((function(t){t.qorder=i.team_results[e].qorder,t.sub_order=a?i.team_results[e].sub_order:u.indexOf(t.qorder)>=0&&t.sub_order||i.team_results[e].sub_order,t.points_order=i.team_results[e].points_order,t.results={matches_won:i.team_results[e].matches_won,matches_lost:i.team_results[e].matches_lost,sets_won:i.team_results[e].sets_won,sets_lost:i.team_results[e].sets_lost,games_won:i.team_results[e].games_won,games_lost:i.team_results[e].games_lost,points_won:i.team_results[e].points_won,points_lost:i.team_results[e].points_lost,matches_ratio:i.team_results[e].matches_ratio,sets_ratio:i.team_results[e].sets_ratio,games_ratio:i.team_results[e].games_ratio,points_ratio:i.team_results[e].points_ratio,ratio_hash:i.team_results[e].ratio_hash},t.result=i.team_results[e].result,t.games=i.team_results[e].games}))})),!0}},n.tallyBracket=et,n}var D=function(){var t={},e=O();function n(t){var n=t.tournament,a=t.source,o=t.env;if(!n.events)return{completed_matches:[],pending_matches:[],upcoming_matches:[],total_matches:0};var s=[],d=[],f=[];function l(t){return["R","Q"].indexOf(t)>=0?0:1}return n.events.map((function(t,e){return{draw_type:t.draw_type,index:e}})).sort((function(t,e){return l(t.draw_type)-l(e.draw_type)})).forEach((function(t){var l,m,p,h=n.events[t.index];g.isRoundRobin({e:h})&&e.roundRobinRounds({event:h});var v=function(t){var n=t.tournament,a=t.e,o=t.source,s=t.env;if(!a.draw)return{complete:[],incomplete:[],upcoming:[]};var d=i(a,n,!1,s);return"round_robin"!=(a.draw.brackets?"round_robin":"tree")||a.links&&a.links.E||d.forEach((function(t){t.round_name&&(t.round_name=t.round_name.replace("Q",""))})),{complete:d.filter((function(t){return t.match&&t.match.winner&&t.match.loser})).map((function(t){return r({tournament:n,e:a,match:t,source:o})})).filter((function(t){return t})),incomplete:d.filter((function(t){return t.match&&!t.match.winner&&!t.match.loser})).map((function(t){return r({tournament:n,e:a,match:t,source:o})})).filter((function(t){return t.players&&t.players.filter((function(t){return t})).length||t.potentials&&t.potentials.length})),upcoming:function(t){var n=t.e,r=t.tournament,a=t.env;if(!n.draw)return[];if(g.isTeam({tournament:r,e:n}))return[];var i=u(r,n);return c({e:n,tournament:r,matches:e.upcomingMatches(n.draw,i.names,i.calculated_names),env:a})}({e:a,tournament:n,env:s}).map((function(t){return r({tournament:n,e:a,match:t,source:o})})).filter((function(t){return t}))||[]}}({tournament:n,e:h,source:a,env:o}),_=v.complete,y=v.incomplete,w=v.upcoming;g.isRoundRobin({e:h})&&(_.sort((function(t,e){return t.round_name&&e.round_name&&t.round_name.localeCompare(e.round_name)})),y.sort((function(t,e){return t.round_name&&e.round_name&&t.round_name.localeCompare(e.round_name)})),w.sort((function(t,e){return t.round_name&&e.round_name&&t.round_name.localeCompare(e.round_name)}))),s=(l=s).concat.apply(l,_),d=(m=d).concat.apply(m,y),f=(p=f).concat.apply(p,w)})),{completed_matches:s,pending_matches:d,upcoming_matches:f,total_matches:s.length+d.length}}function r(t){var e=t.tournament,n=t.e,r=t.match,a=t.source;if(r.match){var i,o,u=[],s=k(r.teams);if(s.length)if(r.match.winner&&r.match.winner[0]){var c,d=k(s[0]),f=k(s[1]);u=(c=[]).concat.apply(c,d.concat(f)),i=[d.map((function(t,e){return e})),f.map((function(t,e){return d.length+e}))]}else{var l;u=(l=[]).concat.apply(l,s),i=s.map((function(t,e){return t?t.map((function(n,r){return e*t.length+r})):[null]}))}else u=[],i=[];var m=r.match.schedule;if(m&&m.luid&&e.locations){var p=e.locations.reduce((function(t,e){return e.luid===m.luid?e:t}),void 0);p&&(o={latitude:p.latitude,longitude:p.longitude})}var h=r.match.matchFormat||n.matchFormat,v={consolation:g.isConsolation({e:n}),draw_positions:n.draw_size,date:r.match.date,schedule:m,location:o,format:g.isDoubles({match:r})||g.isDoubles({e:n})?"doubles":"singles",gender:n.gender,muid:r.match.muid,ids:u.filter((function(t){return t})).map((function(t){return t.id})),players:u,teams:r.teams,set_scores:r.match.set_scores,team_players:i,dependent:r.dependent,dependencies:r.dependencies,potentials:r.potentials,result_order:r.result_order,round:r.round||r.match.round,round_name:r.round_name||r.match.round_name,calculated_round_name:r.calculated_round_name,score:r.match.score,matchFormat:h,delegated_score:r.match.delegated_score,status:r.match.status,tournament:{name:e.name,tuid:e.tuid,org:e.org,start:e.start,end:e.end,rank:e.rank},event:{name:n.name,rank:n.rank,euid:n.euid,surface:n.surface,category:n.category,draw_type:n.draw_type,custom_category:n.custom_category},dual_match:r.dual_match,sequence:r.sequence,umpire:r.match.umpire,winner:r.match.winner_index,winner_index:r.match.winner_index};return a&&(v.source=r.match),v}}function a(t){return t.last_name.toUpperCase()+", "+t.first_name}function i(t,n,r,a){var i=[];if(!t||!t.draw)return i;if(g.isAdHoc({e:t}))i=k(t.draw&&t.draw.matches);else if(g.isTeam({tournament:n,e:t}))Object.keys(t.draw.dual_matches||{}).forEach((function(e){var n,r=t.draw.dual_matches[e].matches||[];r.forEach((function(t){return t.dual_match=e})),i=(n=i).concat.apply(n,r)}));else{var o=u(n,t);i=e.matches(t.draw,o.names,o.calculated_names,r)}return c({e:t,tournament:n,matches:i,env:a}),i}function o(t,e){if(t&&t.events&&!(t.events.length<1))return t.events.reduce((function(t,n){return n.euid===e?n:t}),void 0)}function u(t,n){var r,a=[],i=[];if(g.hasRoundNames({e:n}))if(g.isFeedIn({e:n})){a=["F","SF","QF"];var u=e.drawInfo(n.draw).depth;if(u>3){var s,c=(r=u-3,[].concat(Array(r)).map((function(t,e){return e}))).map((function(t){return"R"+(t+1)})).reverse();a=(s=a).concat.apply(s,c)}}else a=["F","SF","QF","R16","R32","R64","R128","R256","R512"];if(g.isQualifying({e:n})){a=["Q","Q1","Q2","Q3","Q4","Q5"];var d=n.links&&o(t,n.links.E);if(d&&d.draw){var f=e.drawInfo(d.draw);f&&(i=["F","SF","QF","R16","R32","R64","R128","R256","R512","R1024"].slice(f.depth))}}return g.isPlayoff({e:n})&&(a=["PO3"]),{names:a,calculated_names:i}}function c(t){var e=t.tournament,n=t.matches,r=t.env;d(t.e);var a={},i=r&&r.schedule.max_matches_per_court||14;k(e.locations).map((function(t){return t.luid})).forEach((function(t){return function(t,e,n){void 0===n&&(n=14);var r,a=[];return(r=t.locations,Array.isArray(r)&&r||"object"==typeof r&&Object.keys(r).map((function(t){return r[t]}))||[]).forEach((function(t){var r=t.identifiers?t.identifiers.split(","):[];e&&e!==t.luid||w(1,+t.courts+1).forEach((function(e){var i={luid:t.luid,name:t.abbreviation+" "+(r[e-1]||e),availability:w(1,n+1),index:e};a.push(i)}))})),a}(e,t,i).forEach((function(t){return a[y(t)]=t.name}))}));var o=Object.keys(a).length;return n.forEach((function(t){var e=t.match&&t.match.schedule;if(e){if(o&&(e.court=a[y(e)]),e&&e.oop_round&&e.luid){var i=n.filter((function(t){return t.match&&t.match.schedule&&y(t.match.schedule)===y(e)})).filter((function(t){return t.match.schedule.oop_round<e.oop_round&&void 0===t.match.winner}));e.after=i.length}e.time&&(e.time=s.convertTime(e.time,r))}})),n||[]}function d(t){if(t.draw){var n=t.draw.compass?t.draw[t.draw.compass]:t.draw;if(n)if(t.draw.compass)e.compassInfo(t.draw).all_matches.forEach(a);else if(t.draw.brackets)t.draw.brackets.forEach((function(e){return e.matches.forEach((function(e){e.muid||(e.muid=E.new()),e.euid=t.euid}))}));else{var r=e.drawInfo(n);r&&r.nodes&&r.nodes.forEach(a)}}function a(e){var n=e.data&&e.data.nuid||E.new();e.children&&(e.data.match||(e.data.match={}),e.data.match.muid||(e.data.match.muid=n),e.data.match.euid||(e.data.match.euid=t.euid))}}function f(t){console.log({timestamp:t});var e=s.offsetDate(t);return[S(e.getMonth()+1),S(e.getDate())].join("-")}function l(t){var e=s.offsetDate(t);return[S(e.getMonth()+1),S(e.getDate())].join("&#8209;")}return t.activeTeamPlayers=function(e){var n,r,a=e.tournament;if(!g.isTeam({tournament:a})||!a.events)return[];var i=t.tournamentEventMatches({tournament:a}),o=(n=[]).concat.apply(n,i.pending_matches.concat(i.upcoming_matches,[i.completed_matches]));return(r=[]).concat.apply(r,o.map((function(t){return t.players}))).map((function(t){return t&&t.id})).filter((function(t){return t}))},t.matchPlayers=function(t){var e=t.match;if(!e)return[];var n=t.potentials?M(e.potentials||e.match&&e.match.potentials||[]).filter((function(t){return t&&t.id})):[],r=M(e.teams||e.match&&e.match.teams||[]).filter((function(t){return t.id}));if(r.length)return M(r.concat.apply(r,n));var a=M(e.players||e.match&&e.match.players||[]).filter((function(t){return t&&t.id}));if(a.length)return M(a.concat.apply(a,n));var i=M(e.winner||e.match&&e.match.winner||[]).filter((function(t){return t&&t.id})),o=M(e.loser||e.match&&e.match.loser||[]).filter((function(t){return t&&t.id})),u=n.concat.apply(n,i.concat(o));return console.log({match_players:u}),u},t.opponentsInclude=function(e){var n=e.ids;return t.matchPlayers({match:e.match,potentials:e.potentials}).filter((function(t){return t})).reduce((function(t,e){return n.indexOf(e.id)>=0||t}),!1)},t.removeMatchSchedule=function(e){var n=e.e,r=e.tournament,a=e.opponent_ids;if(n&&r&&a){var o=i(n,r,!1,e.env).reduce((function(e,n){return t.opponentsInclude({match:n,ids:a})?n:e}),void 0);o&&o.schedule&&(o.schedule={}),o&&o.match&&o.match.schedule&&(o.match.schedule={})}},t.tournamentEventMatches=n,t.matchOutcome=function(t,e){var n,r,i=null,o=[],u=[];return t.team_players||(t.team_players=t.teams),void 0!==t.winner&&(n=t.team_players[t.winner].map((function(n){var r=t.players[n];return o.push(r.id),r.id===e&&(i=!0),a(r)+(r.rank?" ["+r.rank+"]":"")})).join("; "),r=t.team_players[1-t.winner].map((function(n){var r=t.players[n];return r?(u.push(r.id),r.id===e&&(i=!1),a(r)+(r.rank?" ["+r.rank+"]":"")):"Undefined"})).join("; ")),{player_won:i,winning_team:n,losing_team:r,winning_ids:o,losing_ids:u}},t.scheduledMatches=function(t){var e=n({tournament:t.tournament,source:!0,env:t.env}),r=e.completed_matches,a=r.concat.apply(r,e.pending_matches.concat(e.upcoming_matches)).filter((function(t){return t.schedule&&t.schedule.day})),i=a.map((function(t){return t.schedule.day})).filter((function(t,e,n){return n.lastIndexOf(t)===e}));return{scheduled:a,days:i}},t.dualMatchMatches=function(t,e){if(!t.draw)return[];if(!t.draw.dual_matches)return[];if(e&&t.draw.dual_matches[e])return t.draw.dual_matches[e].matches||[];var n=[];return Object.keys(t.draw.dual_matches||{}).forEach((function(e){var r,a=t.draw.dual_matches[e].matches||[];a.forEach((function(t){return t.dual_match=e})),n=(r=n).concat.apply(r,a)})),n},t.eventMatches=i,t.containsGUIDplayer=function(t){var e,n=t&&(t.match&&t.match.players||t.teams&&(e=[]).concat.apply(e,t.teams));return n&&n.reduce((function(t,e){return!!(e&&e.id&&e.id.length>=36&&5===e.id.split("-").length)||t}),!1)},t.roundNames=u,t.checkScheduledMatches=c,t.eventRoundConsolationReady=function(t){var n=t.draw,r=t.round,a=n&&e.drawInfo(n);if(a&&r&&!isNaN(r)){var i=k(a.all_matches).filter((function(t){return+t.height==+r})),o=i.filter((function(t){return t&&t.data&&t.data.team}));return i.length===o.length}},t.getLuckyLosers=function(e){var n,r=e.tournament,a=e.evnt,i=e.env,o=i.drawFx.ll_all_rounds,u=r&&t.eventMatches(a,r,!1,i).filter((function(t){return t.match.winner}))||[];!o&&g.isQualifying({e:a})&&(u=u.filter((function(t){return"Q"===t.match.round_name})));var s=(n=[]).concat.apply(n,u.map((function(t){return t.match.loser.map((function(t){return t.id}))}))),c=a&&a.qualified&&a.qualified.length&&a.qualified.map((function(t){return t[0].id}))||[],d=r&&r.players.filter((function(t){return s.indexOf(t.id)>=0&&c.indexOf(t.id)<0}))||[];return console.log({qualifying_ids:c,losing_ids:s,losing_players:d}),{losing_ids:s,losing_players:d}},t.addMUIDs=d,t.determineGender=function(t){var e=t.players?t.players.filter((function(t){return t})).map((function(t){return t.sex})).filter((function(t){return t})).filter((function(t,e,n){return n.lastIndexOf(t)===e})):[];return e.length?e.length>1?"X":e[0]:""},t.matchTime=function(t,e){return t.schedule&&t.schedule.time&&s.convertTime(t.schedule.time,e)||""},t.matchRound=function(t){return t.round_name||t.round},t.matchDate=function(t){return t.schedule&&t.schedule.day?f(new Date(t.schedule.day)):t.date?f(t.date):""},t.matchDesignator=function(t){var e=t.match,n=e&&e.event&&o(t.tournament,e.event.euid),r=n&&n.category&&n.category.slice(0,4)||"";return""+n.gender+n.format+r},t.matchDateDisplay=function(t){return t.schedule&&t.schedule.day?l(new Date(t.schedule.day)):t.date?l(t.date):""},t.matchDuration=function(t){return t.schedule&&t.schedule.start&&t.schedule.end?"<b>"+function(t,n){var r=e(n)-e(t);r<=0&&(r=e(n,12)-e(t)),r<=0&&(r=e(n,12)-e(t,-12));var a=Math.floor(r/3600),i=Math.floor(r-60*a*60)/60;return S(a)+":"+S(i)}(t.schedule.start,t.schedule.end)+"</b>":"";function e(t,e){void 0===e&&(e=0);var n=t.split(":"),r=function(t){return t&&!isNaN(t)?+t:0};return 60*(r(n[0])+e)*60+60*r(n[1])}},t.roundPosition=function(t){var n=t.match,r=t.info,a=t.backdrawTarget,i=r&&r.all_matches,o=i&&i.reduce((function(t,e){var r,a;return(null==(r=e.data)||null==(a=r.match)?void 0:a.muid)===(null==n?void 0:n.muid)?e:t}),void 0),u=i&&i.filter((function(t){return o&&o.depth===t.depth})),s=i&&i.filter((function(t){return o&&!e.byeNode(t)&&o.depth===t.depth})),c=a?s:u,d=c&&c.map((function(t){return t&&t.data&&t.data.match&&t.data.match.muid})).filter((function(t){return t})),f=d&&d.indexOf(null==n?void 0:n.muid);return f>=0?(f+1).toString():""},t.roundNumber=function(t){var e=t.match,n=t.info,r=t.DrawStructure,a=n&&n.all_matches,i=a&&a.reduce((function(t,n){var r,a;return(null==(r=n.data)||null==(a=r.match)?void 0:a.muid)===(null==e?void 0:e.muid)?n:t}),void 0);return((n&&n.depth?n.depth-(i&&i.depth||0):"")||("ROUND-ROBIN"===r?e.round:"")||"").toString()},t.matchFinish=function(t){return t.schedule&&t.schedule.end?t.schedule.end:""},t.matchCourt=function(t){return t.schedule&&t.schedule.court||""},t.matchScore=function(t,e){var n=t.score||t.delegated_score||"";return 1===t.winner_index&&(n=b.reverseScore(n)),n&&e?n.replace(/\-/g,"&#8209;"):n},t.isByeMatch=function(t){return t&&t.players&&t.players.filter((function(t){return t})).reduce((function(t,e){return!!e.bye||t}),void 0)},t.idInMatch=function(t){var e=t.match,n=t.id;return e&&e.players&&e.players.reduce((function(t,e){return e.id===n||t}),void 0)},t}();function S(t){return t.toString()[1]?t:"0"+t}function k(t){return Array.isArray(t)&&t||"object"==typeof t&&Object.keys(t).map((function(e){return t[e]}))||[]}function M(t){return t.reduce((function(t,e){return t.concat(Array.isArray(e)?M(e):e)}),[])}var T=t.drawDefinitionConstants.CONTAINER,N=t.drawDefinitionConstants.ITEM,x=t.drawDefinitionConstants.ROUND_OUTCOME,A=t.drawDefinitionConstants.WIN_RATIO,C=O();function F(e){var n,r,a,i,o=e.seedAssignments,u=e.matchUpFormat,s=e.tieFormat,d=e.eventType,f=e.entries,l=e.drawPositionOffset,m=e.participantIds,p=e.participants,h=e.legacyMatch,v=e.tieMatches,_=e.entryStage,g=e.seedLimit,y=e.info,w=[],b=(null==(n=h.match)?void 0:n.muid)||h.muid;if(!h.teams||h.dual_match)return{};var E=D.roundNumber({match:h.match,info:y})||(null==(r=h.match)?void 0:r.round)||(null==h?void 0:h.round),I=isNaN(parseInt(E))?void 0:parseInt(E),O=D.roundPosition({match:h.match,info:y}),S=isNaN(parseInt(O))?void 0:parseInt(O),k=(null==(a=h.match)?void 0:a.calculated_round_name)||(null==(i=h.match)?void 0:i.round_name)||(null==h?void 0:h.round_name)||"",M=v.filter((function(t){return t.dual_match===b})).map((function(e){var n=c({info:y,tieFormat:s,eventType:d,seedLimit:g,entryStage:_,participants:p,participantIds:m,tournamentEngine:t.tournamentEngine,legacyMatch:e}),r=n.matchUp,a=n.missingParticipants;return Object.assign(r,{roundName:k,roundNumber:I,roundPosition:S}),a.length&&console.log({missingParticipants:a}),r})),T=c({info:y,eventType:d,seedLimit:g,entryStage:_,legacyMatch:h,participants:p,matchUpFormat:u,participantIds:m,tournamentEngine:t.tournamentEngine,drawPositionOffset:l}),N=T.matchUp,x=T.missingParticipants,A=T.positionAssignments,C=T.seedAssignments,F=T.entries;return null!=x&&x.filter((function(t){return t})).length&&console.log({missingParticipants:x}),M&&M.forEach((function(t){var e=t.collectionPosition,n=t.matchUpType,r=t.sides,a=null==s?void 0:s.collectionDefinitions.find((function(t){return t.matchUpType===n})),i=null==a?void 0:a.collectionId;null!=r&&r.length&&r.forEach((function(t){var n=t.participantId,r=t.sideNumber,a=N.sides.find((function(t){return t.sideNumber===r}));a.lineUp||(a.lineUp=[]);var o=a.lineUp.find((function(t){return t.participantId===n}));o?o.collectionAssignments.push({collectionId:i,collectionPosition:e}):a.lineUp.push({participantId:n,collectionAssignments:[{collectionId:i,collectionPosition:e}]})}))})),A.forEach((function(t){return w.push(t)})),C.forEach((function(t){return o.push(t)})),F.forEach((function(t){return f.push(t)})),Object.assign(N,{roundName:k,roundNumber:I,roundPosition:S}),M.length&&Object.assign(N,{tieMatchUps:M}),{matchUp:N,positionAssignments:w}}function U(e){var n=e.tournament,r=e.participants,a={},i=n.events||[];t.tournamentEngine.setState({participants:r,tournamentId:"foo"});var s={};i.forEach((function(t){var e=t.euid,n=[e];t.links&&Object.keys(t.links).forEach((function(e){n.push(t.links[e])}));var r,a=h(Object.keys(s),n);a.length?s[a[0]][e]=t:s[e]=((r={})[e]=t,r)})),Object.keys(s).forEach((function(e){var i=s[e],c=Object.keys(i).map((function(t){return i[t]})),d=c.map((function(t){return t.draw_type})),f=["E","S"];h(f,d).length||(d.includes("R")?f.push("R"):d.includes("A")?f.push("A"):d.includes("C")?f.push("C"):d.includes("Q")?f.push("Q"):d.includes("P")?f.push("P"):console.log("unlinked event",{structureGroup:i}));var l=c.find((function(t){return f.includes(t.draw_type)})),g=function(e){return["S","SINGLES"].includes(e.toUpperCase())&&t.eventConstants.SINGLES||["D","DOUBLES"].includes(e.toUpperCase())&&t.eventConstants.DOUBLES}(l.format)||(l.matchorder||"dual"===n.type)&&t.matchUpTypes.TEAM,y=function(t){return{U10:"10U",U12:"12U",U14:"14U",U16:"16U",U18:"18U",10:"10U",12:"12U",14:"14U",16:"16U",18:"18U",Senior:"O18"}[t]}(l.category),w={categoryName:l.category};y&&(w.ageCategoryCode=y);var b,I,O,S=l.name,k=l.automated,M=l.draw_size,U=l.draw_created,R=l.broadcast_name,j=l.custom_category,P=l.category,L=l.matchorder&&(O=(I=t.utilities.unique((b=l.matchorder).map((function(t){return t.format.toUpperCase()}))).map((function(e){var n=b.filter((function(t){return t.format.toUpperCase()===e})),r=(null==n?void 0:n.map((function(t){return parseFloat(t.value)})).filter((function(t){return!isNaN(t)})).reduce((function(t,e){return t+e}),0))||0,a=(n||[]).map((function(t,e){return{collectionPosition:e+1,matchUpValue:parseFloat(t.value)}})),i={matchUpsCount:n.length,collectionName:e,collectionId:t.utilities.UUID(),collectionValue:r,matchUpType:e};return t.utilities.unique(a.map((function(t){return t.matchUpValue}))).length>1?i.collectionValueProfile=a:i.matchUpValue=a[0].matchUpValue,i}))).map((function(t){return t.collectionValue})).reduce((function(t,e){return t+e})),{collectionDefinitions:I,winCriteria:{valueGoal:Math.floor(O/2)+1}}),q=l.score_format,B=l.matchFormat||q&&o.stringify(u.jsonTODS(q)),V=function(e){var n=e.eventType,r=e.tieFormat,a=e.tournament,i=e.participants,s=e.matchUpFormat,c=e.mainStructureId,d={};return{structures:e.legacyEvents.map((function(e){var f=function(t){var e,n=t.eventType,r=t.tieFormat,a=t.tournament,i=t.legacyEvent,o={participants:t.participants,legacyEvent:i,tournament:a,legacyDual:"dual"===a.type,seedLimit:C.seedLimit({total_players:i.approved.length+(i.qualifiers||0)||i.feed_base||i.draw_size,evt:i}),entryStage:_({legacyEvent:i}),tieFormat:r,eventType:n,info:C.drawInfo(i.draw)};return null!=i&&null!=(e=i.draw)&&e.brackets?function(t){var e=t.legacyEvent,n=t.legacyDual,r=t.participants,a=t.entryStage,i=t.seedLimit,o=t.tieFormat,u=t.eventType,s=t.info,c=D.eventMatches(e,t.tournament,!0),d=n&&c||[],f=[],l=[],m=[],p=[],h=e.matchFormat;return e.draw.brackets.forEach((function(t,n){var c=n*(e.draw.bracket_size||0),v=[],_=t.matches.map((function(t){var e=F({seedAssignments:l,entries:p,eventType:u,tieFormat:o,matchUpFormat:h,drawPositionOffset:c,participantIds:m,participants:r,legacyMatch:t,tieMatches:d,entryStage:a,seedLimit:i,info:s});if(e){var n=e.matchUp,f=e.positionAssignments;return f&&v.push.apply(v,f),n}})).filter((function(t){return t})),g=t.name||"Group "+(n+1),y={structureType:N,structureId:E.generate(),stageSequence:1,positionAssignments:v,structureName:g,matchUps:_};f.push(y)})),{entries:p,seedLimit:i,structures:f,seedAssignments:[],structureType:T,finishingPosition:A}}(o):function(t){var e=t.legacyEvent,n=t.tournament,r=t.tieFormat,a=t.legacyDual,i=t.seedLimit,o=t.entryStage,u=t.participants,s=t.eventType,c=t.info,d=D.eventMatches(e,n,!0),f=D.roundNames(n,e),l=C.matches(e.draw,f.names,f.calculated_names,!0),m=a&&d||[],p=[],h=[],v=[],_=[],g=e.matchFormat,y=(a?l:d).map((function(t){var e=F({entries:_,tieFormat:r,eventType:s,matchUpFormat:g,seedAssignments:h,tieMatches:m,legacyMatch:t,participantIds:v,participants:u,entryStage:o,seedLimit:i,info:c});if(e){var n=e.matchUp,a=e.positionAssignments;return a&&p.push.apply(p,a),n}})).filter((function(t){return t}));return p.sort((function(t,e){return t.drawPosition>e.drawPosition?1:-1})),h.sort((function(t,e){return t.seedNumber>e.seedNumber?1:-1})),{entries:_,matchUps:y,seedLimit:i,positionAssignments:p,seedAssignments:h,finishingPosition:x}}(o)}({eventType:n,tieFormat:r,tournament:a,legacyEvent:e,participants:i}),l=f.matchUps,m=f.seedLimit,p=f.structures,h=f.structureType,v=f.finishingPosition,g=f.seedAssignments,y=f.positionAssignments;f.entries.forEach((function(t){d[t.participantId]=t}));var w={stage:e.euid===c?t.drawDefinitionConstants.MAIN:_({legacyEvent:e}),matchUps:l,seedLimit:m,finishingPosition:v,seedAssignments:g,positionAssignments:y,stageSequence:1,structureId:e.euid,structureName:e.name};p&&(w.structures=p),h&&(w.structureType=h);var b=e.score_format,I=e.matchFormat||b&&o.stringify(u.jsonTODS(b));return(I||s)&&(w.matchUpFormat=I||s),w})),drawEntries:Object.values(d)}}({eventType:g,tieFormat:L,tournament:n,participants:r,matchUpFormat:B,mainStructureId:l.euid,legacyEvents:c}),G=V.structures,Q=V.drawEntries,z={drawId:t.utilities.UUID(),drawName:j||R||S||t.factoryConstants.drawDefinitionConstants.MAIN,createdAt:U&&new Date(U).toISOString(),structures:G,entries:Q};B&&(z.matchUpFormat=B);var W={automated:k,drawSize:M,category:{categoryName:P}};L&&(z.tieFormat=L,W.tieFormat=L),t.tournamentEngine.addDrawDefinitionExtension({drawDefinition:z,extension:{name:"drawProfile",value:W}});var H=t.utilities.UUID(),Y=m(l),K=p(l),X=v(l.gender),Z=l.rank,J=w.categoryName+"-"+X+"-"+g;a[J]?(a[J].drawDefinitions.push(z),K&&!a[J].indoorOutdoor&&(a[J].indoorOutdoor=K),Y&&!a[J].surfaceCategory&&(a[J].surfaceCategory=Y)):(a[J]={gender:X,eventId:H,category:w,eventType:g,eventRank:Z,eventName:J,drawDefinitions:[z]},K&&(a[J].indoorOutdoor=K),Y&&(a[J].surfaceCategory=Y))}));var c=Object.values(a);return c.forEach((function(t){var e={};t.drawDefinitions.forEach((function(t){t.entries.forEach((function(t){e[t.participantId]=t}))})),t.entries=Object.values(e)})),{events:c}}var R=O();function j(e){if(e)try{return new Date(e).trim()!==t.errorConditionConstants.INVALID_DATE}catch(t){return!1}}function P(t){return n.normalizeName(t||"",["de","la","da"])}function L(e){if(e){var n=e.split(" "),r=n[0],a=n[1],i=t.utilities.UUID();return{name:e,participantId:i,participantType:t.participantConstants.INDIVIDUAL,participantRole:t.participantRoles.OFFICIAL,person:{personId:i,standardFamilyName:a,standardGivenName:r}}}}function q(e){var n=e.tournament,i=function(t){var e,n,a,i=t.tournament,o=i.tuid,u=null==(e=i.org)?void 0:e.ouid,s=function(t){return(t.locations||[]).map((function(t){var e,n=t.luid,r=t.abbreviation;return{courts:(e=parseInt(t.courts),Array.from({length:e-0},(function(t,e){return e+0}))).map((function(e){return{courtName:r+" "+(t.identifiers&&t.identifiers[e]||e+1),courtId:n+"-"+e}})),venueId:n,venueAbbreviation:r,venueName:t.name,addresses:[{addressType:"VENUE",latitude:t.latitide,longitude:t.longitude,addressLine1:t.address}]}}))}(i),c=m(i),d=p(i),f=function(t){var e,n,r=(null==(e=t.media)?void 0:e.social)||{},a=(null==(n=t.publishing)?void 0:n.sponsors)||[],i=Object.keys(r).map((function(t){return{provider:t,identifier:r[t],type:"SOCIAL_MEDIA"}}));return a.forEach((function(t){i.push({identifier:t,type:"SPONSOR",subType:"LOGO"})})),i}(i),l={tournamentId:o,tournamentName:i.name,startDate:i.start&&new Date(r.format(new Date(i.start),"yyyy-MM-dd")).toISOString(),endDate:i.end&&new Date(r.format(new Date(i.end),"yyyy-MM-dd")).toISOString(),parentOrganisationId:u,unifiedTournamentId:{tournamentId:o,organisationId:u,organisationName:null==(n=i.org)?void 0:n.name,organisationAbbreviation:null==(a=i.org)?void 0:a.abbr}};return s&&(l.venues=s),i.notes&&(l.notes=i.notes),d&&(l.indoorOutdoor=d),f&&(l.onlineResources=f),c&&(l.surfaceCategory=c),{tournamentInfo:l,organisationParticipants:[L(i.judge),(i.umpires||[]).map((function(t){return L(t)}))].filter((function(t){return t}))}}({tournament:n}),o=i.tournamentInfo,u=i.organisationParticipants,s=function(e){var n=e.tournament,a=e.file,i=function(e){var n,a,i=e.tournament,o=[],u=[],s=i.players||[],c=i.start&&r.format(new Date(i.start),"yyyy-MM-dd"),d=i.category,f=null==(n=i.org)?void 0:n.ouid;function l(e){var n,a=e.id||e.puid,i=P(e.last_name),s=P(e.first_name),l=i.toUpperCase()+", "+s,m=j(e.birth)&&r.format(new Date(e.birth),"yyyy-MM-dd"),p={participantName:l,participantId:a,participantType:t.participantConstants.INDIVIDUAL,participantRole:t.participantRoles.COMPETITOR,timeItems:[],person:{personId:a,standardFamilyName:i,standardGivenName:s,sex:v(e.sex),nationalityCode:e.ioc,birthDate:m,otherNames:[]}};(n={player:e,participant:p,tournamentStartDate:c}).participant.timeItems.push({itemSubject:t.participantConstants.SIGN_IN_STATUS,timeStamp:n.tournamentStartDate,itemValue:n.player.signed_in?t.participantConstants.SIGNED_IN:t.participantConstants.SIGNED_OUT}),function(t){var e=t.player;e.nickname&&t.participant.person.otherNames.push(e.nickname)}({player:e,participant:p}),function(t){var e=t.player,n=t.participant,r=t.organisationId;e.cropin&&(n.person.personOtherIds=[{organisationId:r,uniqueOrganisationName:"HTS",personId:e.cropin}]),e.id&&e.puid&&e.puid!==e.id&&(n.person.personOtherIds||(n.person.personOtherIds=[]),n.person.personOtherIds.push({organisationId:r,uniqueOrganisationName:"System",personId:e.puid}))}({player:e,participant:p,organisationId:f}),function(e){var n=e.player,r=e.participant,a=e.tournamentStartDate,i=e.tournamentCategory;n.rankings&&Object.keys(n.rankings).forEach((function(e){r.timeItems.push({itemType:t.scaleConstants.SCALE+"."+t.scaleConstants.RANKING+".SINGLES."+e,itemValue:n.rankings[e],timestamp:a})})),n.category_dbls&&i&&r.timeItems.push({itemType:t.scaleConstants.SCALE+"."+t.scaleConstants.RANKING+".SINGLES."+i,itemValue:n.category_dbls,timestamp:a})}({player:e,participant:p,tournamentStartDate:c,tournamentCategory:d}),function(e){var n=e.player,r=e.participant,a=e.tournamentStartDate;n.ratings&&Object.keys(n.ratings).forEach((function(e){Object.keys(n.ratings[e]).forEach((function(i){var o={itemType:t.scaleConstants.SCALE+"."+t.scaleConstants.RATING+"."+i.toUpperCase()+"."+e.toUpperCase(),itemValue:n.ratings[e][i].value,timestamp:a};o.itemValue&&r.timeItems.push(o)}))}))}({player:e,participant:p,tournamentStartDate:c}),function(e){var n=e.player,r=e.participant,a=e.tournamentStartDate;function i(e){var n,r,a,i,o,u,s,c,d,f,l;return"unsporting"===(null==(n=e.penalty)?void 0:n.value)?t.penaltyConstants.UNSPORTSMANLIKE_CONDUCT:"fail2signout"===(null==(r=e.penalty)?void 0:r.value)?t.penaltyConstants.FAILURE_TO_COMPLETE:"illegalcoaching"===(null==(a=e.penalty)?void 0:a.value)?t.penaltyConstants.COACHING:"ballabuse"===(null==(i=e.penalty)?void 0:i.value)?t.penaltyConstants.BALL_ABUSE:"racquetabuse"===(null==(o=e.penalty)?void 0:o.value)?t.penaltyConstants.RACKET_ABUSE:"equipmentabuse"===(null==(u=e.penalty)?void 0:u.value)?t.penaltyConstants.EQUIMENT_VIOLATION:"cursing"===(null==(s=e.penalty)?void 0:s.value)||"rudegestures"===(null==(c=e.penalty)?void 0:c.value)||"foullanguage"===(null==(d=e.penalty)?void 0:d.value)?t.penaltyConstants.UNSPORTSMANLIKE_CONDUCT:"timeviolation"===(null==(f=e.penalty)?void 0:f.value)||"latearrival"===(null==(l=e.penalty)?void 0:l.value)?t.penaltyConstants.PUNCTUALITY:void 0}n.penalties&&(r.penalties=[],n.penalties.forEach((function(e){var n,o=j(e.time)&&e.time||a,u={penaltyId:t.utilities.UUID(),matchUpId:e.muid,penaltyType:i(e),notes:null==(n=e.penalty)?void 0:n.label,createdAt:new Date(o).toISOString()};r.penalties.push(u)})))}({player:e,participant:p,tournamentStartDate:c}),u.includes(p.participantId)||(o.push(p),u.push(a))}return s.forEach(l),((null==(a=i.events)?void 0:a.filter((function(t){return t.draw})))||[]).forEach((function(t){R.matches(t.draw).map((function(t){return t.teams})).flat(Infinity).filter((function(t){return t&&!t.players})).forEach(l)})),o}({tournament:n}),o=function(e){var n=e.tournament,r=e.participants,a=[],i="dual"===n.type;return(n.events||[]).filter((function(t){return"D"===t.format||i})).forEach((function(e){D.eventMatches(e,n,!0).map((function(t){return t.teams})).flat().filter((function(t){return Array.isArray(t)&&2===t.length})).forEach((function(e){var n=e.map((function(t){return r.find((function(e){var n,r,a=e.participantId===(null==t?void 0:t.id),i=null==e||null==(n=e.person)||null==(r=n.personOtherIds)?void 0:r.find((function(e){return e.personId===(null==t?void 0:t.id)}));return a||i}))})).filter((function(t){return t}));if(2===n.length){var i=n.map((function(t){return t.person.standardFamilyName})).join("/"),o=n.map((function(t){return t.participantId})),u={participantId:t.utilities.UUID(),participantType:t.participantConstants.PAIR,participantRole:t.participantRoles.COMPETITOR,individualParticipantIds:o,participantName:i};a.push(u)}}))})),a}({participants:i,tournament:n,file:a}),u=(n.teams||[]).map((function(e){var n=Object.keys(e.players);return{participantId:e.id,participantType:t.participantConstants.TEAM,participantRole:t.participantRoles.COMPETITOR,individualParticipantIds:n,participantName:e.name}}));return{competitorParticipants:i.concat.apply(i,o.concat(u))}}({tournament:n}).competitorParticipants,c=s.concat.apply(s,u);return{tournamentRecord:a({},o,{participants:c,events:U({tournament:n,participants:c}).events})}}exports.default=q,exports.getTournamentRecordTODS=q;
//# sourceMappingURL=tods-tmx-legacy-converter.cjs.production.min.js.map
